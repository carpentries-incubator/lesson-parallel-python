<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>Lesson Title: All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="../assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="../assets/styles.css">
<script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../favicons/incubator/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicons/incubator/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../favicons/incubator/favicon-16x16.png">
<link rel="manifest" href="../favicons/incubator/site.webmanifest">
<link rel="mask-icon" href="../favicons/incubator/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="white">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="black">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="incubator-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo.svg"><span class="badge text-bg-info">
          <abbr title="This lesson is in the beta phase, which means that it is ready for teaching by instructors outside of the original author team.">
            <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#polishing-beta-stage" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-circle" style="border-radius: 5px"></i>
              Beta
            </a>
            <span class="visually-hidden">This lesson is in the beta phase, which means that it is ready for teaching by instructors outside of the original author team.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text">
<li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul>
</li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='../aio.html';">Learner View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      Lesson Title
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            Lesson Title
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><hr></ul>
</li>
      </ul>
</div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="../instructor/aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Lesson Title
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text">
<li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul>
</li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../aio.html">Learner View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->

            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="introduction.html">1. Introduction</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="benchmarking.html">2. Benchmarking</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="computing-pi.html">3. Computing $\pi$</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="threads-and-processes.html">4. Threads And Processes</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="delayed-evaluation.html">5. Delayed Evaluation</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="map-and-reduce.html">6. Map and Reduce</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="exercise-with-fractals.html">7. Exercise with Fractals</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="extra-asyncio.html">8. Asyncio</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush10">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading10">
        <a href="extra-external-c.html">9. Calling External C and C++ Libraries from Python</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      <hr>
</ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources">
<a href="../instructor/aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">

            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-introduction"><p>Content from <a href="introduction.html">Introduction</a></p>
<hr>
<p>Last updated on 2025-03-31 |

        <a href="https://example.com/template-source/edit/main/episodes/introduction.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 25 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What problems are we solving, and what are we <strong>not</strong>
discussing?</li>
<li>Why do we use Python?</li>
<li>What is parallel programming?</li>
<li>Why can writing a parallel program be challenging?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Recognize serial and parallel patterns.</li>
<li>Identify problems that can be parallelized.</li>
<li>Understand a dependency diagram.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="common-problems">Common problems<a class="anchor" aria-label="anchor" href="#common-problems"></a>
</h1>
<div id="what-problems-are-we-solving" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="what-problems-are-we-solving" class="callout-inner">
<h3 class="callout-title">What problems are we solving?</h3>
<div class="callout-content">
<p>Ask around what problems participants encountered: “Why did you sign
up?” Specifically: “Which task in your field of expertise do you want to
parallelize?”</p>
</div>
</div>
</div>
<p>Most problems will fit in either category: - I wrote this code in
Python and it is not fast enough. - I run this code on my laptop, but
the target size of the problem is bigger than its RAM.</p>
<p>In this course we show several ways of speeding up your program and
making it run in parallel. We introduce the following modules:</p>
<ol style="list-style-type: decimal">
<li>
<code>threading</code> allows different parts of your program to run
concurrently on a single computer (with shared memory).</li>
<li>
<code>dask</code> makes scalable parallel computing easy.</li>
<li>
<code>numba</code> speeds up your Python functions by translating
them to optimized machine code.</li>
<li>
<code>memory_profile</code> monitors memory performance.</li>
<li>
<code>asyncio</code> is Python’s native asynchronous
programming.</li>
</ol>
<p>FIXME: Actually explain functional programming and distributed
programming. More importantly, we show how to change the design of a
program to fit parallel paradigms. This often involves techniques from
<strong>functional programming</strong>.</p>
<div id="what-we-wont-talk-about" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="what-we-wont-talk-about" class="callout-inner">
<h3 class="callout-title">What we won’t talk about</h3>
<div class="callout-content">
<p>In this course we will not talk about <strong>distributed
programming</strong>. This is a huge can of worms. It is easy to show
simple examples, but solutions for particular problems will be wildly
different. Dask has a lot of functionalities to help you set up runs on
a network. The important bit is that, once you have made your code
suitable for parallel computing, you will have the right mindset to get
it to work in a distributed environment.</p>
</div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="overview-and-rationale">Overview and rationale<a class="anchor" aria-label="anchor" href="#overview-and-rationale"></a>
</h1>
<p>FIXME: update this to newer lesson content organisation.</p>
<p>This is an advanced course. Why is it advanced? We (hopefully) saw in
the discussion that, although many of your problems share similar
characteristics, the details will determine the solution. We all need
our algorithms, models, analysis to run so that many hands make light
work. When such a situation arises in a group of people, we start with a
meeting discussing who does what, when do we meet again and sync up, and
so on. After a while you can get the feeling that all you do is to be in
meetings. We will see that several abstractions can make our life
easier. This course illustrates these abstractions making ample use of
Dask.</p>
<ul>
<li>Vectorized instructions: tell many workers to do the same work on a
different piece of data. This is where <code>dask.array</code> and
<code>dask.dataframe</code> come in. We illustrate this model of working
by computing the number <span class="math inline">\(\pi\)</span> later
on.</li>
<li>Map/filter/reduce: this methodology combines different functionals
to create a larger program. We implement this formalism when using
<code>dask.bag</code> to count the number of unique words in a
novel.</li>
<li>Task-based parallelization: this may be the most generic
abstraction, as all the others can be expressed in terms of tasks or
workflows. This is <code>dask.delayed</code>.</li>
</ul>
</div>
<div class="section level1">
<h1 id="why-python">Why Python?<a class="anchor" aria-label="anchor" href="#why-python"></a>
</h1>
<p>Python is one of most widely used languages for scientific data
analysis, visualization, and even modelling and simulation. The
popularity of Python is mainly due to the two pillars of the friendly
syntax and the availability of many high-quality libraries.</p>
<div id="its-not-all-good-news" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="its-not-all-good-news" class="callout-inner">
<h3 class="callout-title">It’s not all good news</h3>
<div class="callout-content">
<p>The flexibility of Python comes with a few downsides, though: -
Python code typically does not perform as fast as lower-level
implementations in C/C++ or Fortran. - Parallelizing Python code to work
efficiently on many-core architectures is not trivial.</p>
<p>This workshop addresses both issues, with an emphasis on running
parallel Python code efficiently on multiple cores.</p>
</div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="what-is-parallel-computing">What is parallel computing?<a class="anchor" aria-label="anchor" href="#what-is-parallel-computing"></a>
</h1>
<div class="section level2">
<h2 id="dependency-diagrams">Dependency diagrams<a class="anchor" aria-label="anchor" href="#dependency-diagrams"></a>
</h2>
<p>Suppose we have a computation where each step
<strong>depends</strong> on a previous one. We can represent this
situation in the schematic below, known as a dependency diagram:</p>
<figure><img src="../fig/serial.png" alt="boxes and arrows in sequential configuration" class="figure mx-auto d-block"><div class="figcaption">Serial computation</div>
</figure><p>In these diagrams rectangles represent the inputs and outputs of each
function. The inward and outward arrows indicate their flow. Note that
the output of one function can become the input of another one. The
diagram above is the typical diagram of a <strong>serial
computation</strong>. If you ever used a loop to update a value, you
used serial computation.</p>
<p>If our computation involves <strong>independent work</strong> (that
is, the results of each function are independent of the results of
applying the rest), we can structure our computation as follows:</p>
<figure><img src="../fig/parallel.png" alt="boxes and arrows with two parallel pipe lines" class="figure mx-auto d-block"><div class="figcaption">Parallel computation</div>
</figure><p>This scheme represents a <strong>parallel computation</strong>.</p>
<div class="section level3">
<h3 id="how-can-parallel-computing-improve-our-code-execution-speed">How can parallel computing improve our code execution speed?<a class="anchor" aria-label="anchor" href="#how-can-parallel-computing-improve-our-code-execution-speed"></a>
</h3>
<p>Nowadays, most personal computers have 4 or 8 processors (also known
as cores). In the diagram above, we can assign each of the three
functions to one core, so they can be performed simultaneously.</p>
<div id="do-eight-processors-work-eight-as-fast-as-one" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="do-eight-processors-work-eight-as-fast-as-one" class="callout-inner">
<h3 class="callout-title">Do eight processors work eight as fast as one?</h3>
<div class="callout-content">
<p>It may be tempting to think that using eight cores instead of one
would increase the execution speed eightfold. For now, it is OK to use
this as a first approximation to reality. Later in the course we see
that things are actually more complicated.</p>
</div>
</div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="parallelizable-and-non-parallelizable-tasks">Parallelizable and non-parallelizable tasks<a class="anchor" aria-label="anchor" href="#parallelizable-and-non-parallelizable-tasks"></a>
</h2>
<p>Some tasks are easily parallelizable while others are not so
inherently. However, it might not always be immediately apparent that a
task is parallelizable.</p>
<p>Let us consider the following piece of code:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>x <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>] <span class="co"># Write input</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>y <span class="op">=</span> <span class="dv">0</span> <span class="co"># Initialize output</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(x)):</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>  y <span class="op">+=</span> x[i] <span class="co"># Add each element to the output variable</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="bu">print</span>(y) <span class="co"># Print output</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">10</span></span></code></pre>
</div>
<p>Note that each successive loop uses the result of the previous loop.
In that way, it depends on the previous loop. The following dependency
diagram makes that clear:</p>
<figure><img src="../fig/serial.svg" alt="boxes and arrows" class="figure mx-auto d-block"><div class="figcaption">serial execution</div>
</figure><p>Although we are performing the loops in a serial way in the snippet
above, nothing prevents us from performing this calculation in parallel.
The following example shows that parts of the computations can be done
independently:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>x <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>]</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>chunk1 <span class="op">=</span> x[:<span class="dv">2</span>]</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>chunk2 <span class="op">=</span> x[<span class="dv">2</span>:]</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>sum_1 <span class="op">=</span> <span class="bu">sum</span>(chunk1)</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>sum_2 <span class="op">=</span> <span class="bu">sum</span>(chunk2)</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>result <span class="op">=</span> sum_1 <span class="op">+</span> sum_2</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="bu">print</span>(result)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">10</span></span></code></pre>
</div>
<figure><img src="../fig/parallel.svg" alt="boxes and arrows" class="figure mx-auto d-block"><div class="figcaption">parallel execution</div>
</figure><p><strong>Chunking</strong> is the technique for parallelizing
operations like these sums.</p>
<p>There is a subclass of algorithms where the subtasks are completely
independent. These kinds of algorithms are known as <a href="https://en.wikipedia.org/wiki/Embarrassingly_parallel" class="external-link">embarrassingly
parallel</a> or, more friendly, naturally or delightfully parallel.</p>
<p>An example of this kind of problem is squaring each element in a
list, which can be done as follows:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>x <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>]</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>y <span class="op">=</span> [n<span class="op">**</span><span class="dv">2</span> <span class="cf">for</span> n <span class="kw">in</span> x]</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="bu">print</span>(y)</span></code></pre>
</div>
<p>Each task of squaring a number is independent of all other elements
in the list.</p>
<p>It is important to know that some tasks are fundamentally
non-parallelizable. An example of such an <strong>inherently
serial</strong> algorithm is the computation of the Fibonacci sequence
using the formula <code>Fn=Fn-1 + Fn-2</code>. Each output depends on
the outputs of the two previous loops.</p>
<div id="challenge-parallellizable-and-non-parallellizable-tasks" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-parallellizable-and-non-parallellizable-tasks" class="callout-inner">
<h3 class="callout-title">Challenge: Parallellizable and non-parallellizable tasks</h3>
<div class="callout-content">
<p>Can you think of a task in your domain that is parallelizable? Can
you also think of one that is fundamentally non-parallelizable?</p>
<p>Please write your answers in the collaborative document.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>Answers may vary. An ubiquitous example of a naturally parallel
problem is a parameter scan, where you need to evaluate some model for N
different configurations of input parameters.</p>
<p>Time-dependent models are a category of problems very hard to
parallelize, since every state depends on the previous one(s). The
attempts to parallelize those cases require fundamentally different
algorithms.</p>
<p>In many cases fully paralellizable algorithms may be a bit less
efficient per CPU cycle than their single threaded brethren.</p>
</div>
</div>
</div>
</div>
<div id="problems-versus-algorithms" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="problems-versus-algorithms" class="callout-inner">
<h3 class="callout-title">Problems versus Algorithms</h3>
<div class="callout-content">
<p>Often, the parallelizability of a problem depends on its specific
implementation. For instance, in our first example of a
non-parallelizable task, we mentioned the calculation of the Fibonacci
sequence. Conveniently, a <a href="https://en.wikipedia.org/wiki/Fibonacci_number#Closed-form_expression" class="external-link">closed
form expression to compute the n-th Fibonacci number</a> exists.</p>
<p>Last but not least, do not let the name discourage you: if your
algorithm happens to be embarrassingly parallel, that’s good news! The
adverb “embarrassingly” evokes the feeling of “this is great!, how did I
not notice before?!”</p>
</div>
</div>
</div>
<div id="challenge-parallelized-pea-soup" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-parallelized-pea-soup" class="callout-inner">
<h3 class="callout-title">Challenge: Parallelized Pea Soup</h3>
<div class="callout-content">
<p>We have the following recipe:</p>
<ol style="list-style-type: decimal">
<li>(1 min) Pour water into a soup pan, add the split peas and bay leaf,
and bring it to boil.</li>
<li>(60 min) Remove any foam using a skimmer, and let it simmer under a
lid for about 60 minutes.</li>
<li>(15 min) Clean and chop the leek, celeriac, onion, carrot and
potato.</li>
<li>(20 min) Remove the bay leaf, add the vegetables, and simmer for 20
more minutes. Stir the soup occasionally.</li>
<li>(1 day) Leave the soup for one day. Re-heat before serving and add a
sliced smoked sausage (vegetarian options are also welcome). Season with
pepper and salt.</li>
</ol>
<p>Imagine you are cooking alone.</p>
<ul>
<li>Can you identify potential for parallelisation in this recipe?</li>
<li>And what if you are cooking with a friend’s help? Is the soup done
any faster?</li>
<li>Draw a dependency diagram.</li>
</ul>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<ul>
<li>You can cut vegetables while simmering the split peas.</li>
<li>If you have help, you can parallelize cutting vegetables
further.</li>
<li>There are two ‘workers’: the cook and the stove. <img src="../fig/soup.png" alt="boxes and arrows showing dependencies between tasks" class="figure">
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="shared-vs--distributed-memory">Shared vs. distributed memory<a class="anchor" aria-label="anchor" href="#shared-vs--distributed-memory"></a>
</h2>
<p>FIXME: add text</p>
<figure><img src="../fig/memory-architecture.svg" alt="diagram" class="figure mx-auto d-block"><div class="figcaption">Shared vs. Distributed memory architecture: the
crucial difference is the bandwidth to shared memory</div>
</figure><div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Programs are parallelizable if you can identify independent
tasks.</li>
<li>To make programs scalable, you need to chunk the work.</li>
<li>Parallel programming often triggers a redesign; we use different
patterns.</li>
<li>Doing work in parallel does not always give a speed-up.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div>
</div></section><section id="aio-benchmarking"><p>Content from <a href="benchmarking.html">Benchmarking</a></p>
<hr>
<p>Last updated on 2025-03-31 |

        <a href="https://example.com/template-source/edit/main/episodes/benchmarking.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 60 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do we know whether our program ran faster in parallel?</li>
<li>How do we appraise efficiency?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>View performance on system monitor.</li>
<li>Find out how many cores your machine has.</li>
<li>Use <code>%time</code> and <code>%timeit</code> line-magic.</li>
<li>Use a memory profiler.</li>
<li>Plot performance against number of work units.</li>
<li>Understand the influence of hyper-threading on timings.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="a-first-example-with-dask">A first example with Dask<a class="anchor" aria-label="anchor" href="#a-first-example-with-dask"></a>
</h1>
<p>We will create parallel programs in Python later. First let’s see a
small example. Open your System Monitor (the application will vary
between specific operating systems), and run the following code
examples:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># Summation making use of numpy:</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>result <span class="op">=</span> np.arange(<span class="dv">10</span><span class="op">**</span><span class="dv">7</span>).<span class="bu">sum</span>()</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># The same summation, but using dask to parallelize the code.</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="co"># NB: the API for dask arrays mimics that of numpy</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="im">import</span> dask.array <span class="im">as</span> da</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>work <span class="op">=</span> da.arange(<span class="dv">10</span><span class="op">**</span><span class="dv">7</span>).<span class="bu">sum</span>()</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>result <span class="op">=</span> work.compute()</span></code></pre>
</div>
<div id="try-a-heavy-enough-task" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="try-a-heavy-enough-task" class="callout-inner">
<h3 class="callout-title">Try a heavy enough task</h3>
<div class="callout-content">
<p>Your system monitor may not detect so small a task. In your computer
you may have to gradually raise the problem size to <code>10**8</code>
or <code>10**9</code> to observe the effect in long enough a run. But be
careful and increase slowly! Asking for too much memory can make your
computer slow to a crawl.</p>
</div>
</div>
</div>
<figure><img src="../fig/system-monitor.jpg" alt="screenshot of system monitor" class="figure mx-auto d-block"><div class="figcaption">System monitor</div>
</figure><p>How can we monitor this more conveniently? In Jupyter we can use some
line magics, small “magic words” preceded by the symbol <code>%%</code>
that modify the behaviour of the cell.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>np.arange(<span class="dv">10</span><span class="op">**</span><span class="dv">7</span>).<span class="bu">sum</span>()</span></code></pre>
</div>
<p>The <code>%%time</code> line magic checks how long it took for a
computation to finish. It does not affect how the computation is
performed. In this regard it is very similar to the <code>time</code>
shell command.</p>
<p>If we run the chunk several times, we will notice variability in the
reported times. How can we trust this timer, then? A possible solution
will be to time the chunk several times, and take the average time as
our valid measure. The <code>%%timeit</code> line magic does exactly
this in a concise and convenient manner! <code>%%timeit</code> first
measures how long it takes to run a command once, then repeats it enough
times to get an average run-time. Also, <code>%%timeit</code> can
measure run times discounting the overhead of setting up a problem and
measuring only the performance of the code in the cell. So this outcome
is more trustworthy.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="op">%%</span>timeit</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>np.arange(<span class="dv">10</span><span class="op">**</span><span class="dv">7</span>).<span class="bu">sum</span>()</span></code></pre>
</div>
<p>You can store the output of <code>%%timeit</code> in a Python
variable using the <code>-o</code> flag:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>time <span class="op">=</span> <span class="op">%</span>timeit <span class="op">-</span>o np.arange(<span class="dv">10</span><span class="op">**</span><span class="dv">7</span>).<span class="bu">sum</span>()</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Time taken: </span><span class="sc">{</span>time<span class="sc">.</span>average<span class="sc">:.4f}</span><span class="ss"> s"</span>)</span></code></pre>
</div>
<p>Note that this metric does not tell you anything about memory
consumption or efficiency.</p>
<div id="timeit" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="timeit" class="callout-inner">
<h3 class="callout-title">Timeit</h3>
<div class="callout-content">
<p>Use <code>timeit</code> to time the following snippets:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>[x<span class="op">**</span><span class="dv">2</span> <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>)]</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="bu">map</span>(<span class="kw">lambda</span> x: x<span class="op">**</span><span class="dv">2</span>, <span class="bu">range</span>(<span class="dv">100</span>))</span></code></pre>
</div>
<p>Can you explain the difference? How about the following</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>):</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    x<span class="op">**</span><span class="dv">2</span></span></code></pre>
</div>
<p>Is that faster than the first one? Why?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>Python’s <code>map</code> function is lazy. It won’t compute anything
until you iterate it. Try <code>list(map(...))</code>. The third example
doesn’t allocate any memory, which makes it faster.</p>
</div>
</div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="memory-profiling">Memory profiling<a class="anchor" aria-label="anchor" href="#memory-profiling"></a>
</h1>
<ul>
<li>
<strong>Benchmarking</strong> is the action of systematically
testing performance under different conditions.</li>
<li>
<strong>Profiling</strong> is the analysis of which parts of a
program contribute to the total performance, and the identification of
possible bottlenecks.</li>
</ul>
<p>We will use the package <a href="https://github.com/pythonprofilers/memory_profiler" class="external-link"><code>memory_profiler</code></a>
to track memory usage. It can be installed executing the code below in
the console:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">SH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode sh" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="ex">pip</span> install memory_profiler</span></code></pre>
</div>
<p>The memory usage of the serial and parallel versions of a code will
vary. In Jupyter, type the following lines to see the effect in the code
presented above (again, increase the baseline value <code>10**7</code>
if needed):</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="im">import</span> dask.array <span class="im">as</span> da</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="im">from</span> memory_profiler <span class="im">import</span> memory_usage</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="kw">def</span> sum_with_numpy():</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>    <span class="co"># Serial implementation</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>    np.arange(<span class="dv">10</span><span class="op">**</span><span class="dv">7</span>).<span class="bu">sum</span>()</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a><span class="kw">def</span> sum_with_dask():</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>    <span class="co"># Parallel implementation</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>    work <span class="op">=</span> da.arange(<span class="dv">10</span><span class="op">**</span><span class="dv">7</span>).<span class="bu">sum</span>()</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>    work.compute()</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>memory_numpy <span class="op">=</span> memory_usage(sum_with_numpy, interval<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>memory_dask <span class="op">=</span> memory_usage(sum_with_dask, interval<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a><span class="co"># Plot results</span></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>plt.plot(memory_numpy, label<span class="op">=</span><span class="st">'numpy'</span>)</span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>plt.plot(memory_dask, label<span class="op">=</span><span class="st">'dask'</span>)</span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>plt.xlabel(<span class="st">'Interval counter [-]'</span>)</span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>plt.ylabel(<span class="st">'Memory usage [MiB]'</span>)</span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>plt.legend()</span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>plt.show()</span></code></pre>
</div>
<p>The plot should be similar to the one below:</p>
<figure><img src="../fig/memory.png" alt="showing very high peak for numpy, and constant low line for dask" class="figure mx-auto d-block"><div class="figcaption">Memory performance</div>
</figure><div id="exercise-plenary" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="exercise-plenary" class="callout-inner">
<h3 class="callout-title">Exercise (plenary)</h3>
<div class="callout-content">
<p>Why is the Dask solution more memory-efficient?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>Chunking! Dask chunks the large array so that the data is never
entirely in memory.</p>
</div>
</div>
</div>
</div>
<div id="profiling-from-dask" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="profiling-from-dask" class="callout-inner">
<h3 class="callout-title">Profiling from Dask</h3>
<div class="callout-content">
<p>Dask has several built-in option for profiling. See the <a href="https://docs.dask.org/en/latest/diagnostics-local.html" class="external-link">dask
documentation</a> for more information.</p>
</div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="using-many-cores">Using many cores<a class="anchor" aria-label="anchor" href="#using-many-cores"></a>
</h1>
<p>Using more cores for a computation can decrease the run time. The
first question is of course: how many cores do I have? See the snippet
below to find this out:</p>
<div id="find-out-the-number-of-cores-in-your-machine" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="find-out-the-number-of-cores-in-your-machine" class="callout-inner">
<h3 class="callout-title">Find out the number of cores in your machine</h3>
<div class="callout-content">
<p>The number of cores can be found from Python upon executing:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="im">import</span> psutil</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>N_physical_cores <span class="op">=</span> psutil.cpu_count(logical<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>N_logical_cores <span class="op">=</span> psutil.cpu_count(logical<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"The number of physical/logical cores is </span><span class="sc">{</span>N_physical_cores<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>N_logical_cores<span class="sc">}</span><span class="ss">"</span>)</span></code></pre>
</div>
</div>
</div>
</div>
<p>Usually the number of logical cores is higher than the number of
physical cores. This is due to <em>hyper-threading</em>, which enables
each physical CPU core to execute several threads at the same time. Even
with simple examples, performance may scale unexpectedly. There are many
reasons for this, hyper-threading being one of them. See the ensuing
example.</p>
<p>On a machine with 4 physical and 8 logical cores, this admittedly
over-simplistic benchmark:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>x <span class="op">=</span> []</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">9</span>):</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>    time_taken <span class="op">=</span> <span class="op">%</span>timeit <span class="op">-</span>r <span class="dv">1</span> <span class="op">-</span>o da.arange(<span class="dv">5</span><span class="op">*</span><span class="dv">10</span><span class="op">**</span><span class="dv">7</span>).<span class="bu">sum</span>().compute(num_workers<span class="op">=</span>n)</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>    x.append(time_taken.average)</span></code></pre>
</div>
<p>gives the result:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>data <span class="op">=</span> pd.DataFrame({<span class="st">"n"</span>: <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">9</span>), <span class="st">"t"</span>: x})</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>data.set_index(<span class="st">"n"</span>).plot()</span></code></pre>
</div>
<figure><img src="../fig/more-cores.svg" alt="showing that using more cores can also make things slower" class="figure mx-auto d-block"><div class="figcaption">Timings against number of cores</div>
</figure><div id="discussion" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="discussion" class="callout-inner">
<h3 class="callout-title">Discussion</h3>
<div class="callout-content">
<p>Why does the runtime increase if we add more than 4 cores? This has
to do with <strong>hyper-threading</strong>. On most architectures it
does not make much sense to use more workers than the physical cores you
have.</p>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Understanding performance is often non-trivial.</li>
<li>Memory is just as important as speed.</li>
<li>To measure is to know.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div></section><section id="aio-computing-pi"><p>Content from <a href="computing-pi.html">Computing $\pi$</a></p>
<hr>
<p>Last updated on 2025-03-31 |

        <a href="https://example.com/template-source/edit/main/episodes/computing-pi.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 90 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do I parallelize a Python application?</li>
<li>What is data parallelism?</li>
<li>What is task parallelism?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Rewrite a program in a vectorized form.</li>
<li>Understand the difference between data-based and task-based parallel
programming.</li>
<li>Apply <code>numba.jit</code> to accelerate Python.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="parallelizing-a-python-application">Parallelizing a Python application<a class="anchor" aria-label="anchor" href="#parallelizing-a-python-application"></a>
</h1>
<p>In order to recognize the advantages of parallelism we need an
algorithm that is easy to parallelize, complex enough to take a few
seconds of CPU time, understandable, and also interesting not to scare
away the interested learner. Estimating the value of number <span class="math inline">\(\pi\)</span> is a classical problem to demonstrate
parallel programming.</p>
<p>The algorithm we present is a classical demonstration of the power of
Monte Carlo methods. This is a category of algorithms using random
numbers to approximate exact results. This approach is simple and has a
straightforward geometrical interpretation.</p>
<p>We can compute the value of <span class="math inline">\(\pi\)</span>
using a random number generator. We count the points falling inside the
blue circle M compared to the green square N. The ratio 4M/N then
approximates <span class="math inline">\(\pi\)</span>.</p>
<figure><img src="../fig/calc_pi_3_wide.svg" alt="the area of a unit sphere contains a multiple of pi" class="figure mx-auto d-block"><div class="figcaption">Computing Pi</div>
</figure><div id="challenge-implement-the-algorithm" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-implement-the-algorithm" class="callout-inner">
<h3 class="callout-title">Challenge: Implement the algorithm</h3>
<div class="callout-content">
<p>Use only standard Python and the method <code>random.uniform</code>.
The function should have the following interface:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="kw">def</span> calc_pi(N):</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>    <span class="co">"""Computes the value of pi using N random samples."""</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>    ...</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>        <span class="co"># take a sample</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>        ...</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>    <span class="cf">return</span> ...</span></code></pre>
</div>
<p>Also, make sure to time your function!</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="kw">def</span> calc_pi(N):</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    M <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>        <span class="co"># Simulate impact coordinates</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>        x <span class="op">=</span> random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>        y <span class="op">=</span> random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>        <span class="co"># True if impact happens inside the circle</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>        <span class="cf">if</span> x<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> y<span class="op">**</span><span class="dv">2</span> <span class="op">&lt;</span> <span class="fl">1.0</span>:</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>            M <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">4</span> <span class="op">*</span> M <span class="op">/</span> N</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a><span class="op">%</span>timeit calc_pi(<span class="dv">10</span><span class="op">**</span><span class="dv">6</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>676 ms ± 6.39 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Before we parallelize this program, the inner function must be as
efficient as we can make it. We show two techniques for doing this:
<em>vectorization</em> using <code>numpy</code>, and <em>native code
generation</em> using <code>numba</code>.</p>
<p>We first demonstrate a Numpy version of this algorithm:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="kw">def</span> calc_pi_numpy(N):</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    <span class="co"># Simulate impact coordinates</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>    pts <span class="op">=</span> np.random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, (<span class="dv">2</span>, N))</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>    <span class="co"># Count number of impacts inside the circle</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>    M <span class="op">=</span> np.count_nonzero((pts<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>) <span class="op">&lt;</span> <span class="dv">1</span>)</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">4</span> <span class="op">*</span> M <span class="op">/</span> N</span></code></pre>
</div>
<p>This is a <strong>vectorized</strong> version of the original
algorithm. A problem written in a vectorized form becomes amenable to
<strong>data parallelization</strong>, where each single operation is
replicated over a large collection of data. Data parallelism contrasts
with <strong>task parallelism</strong>, where different independent
procedures are performed in parallel. An example of task parallelism is
the pea-soup recipe in the introduction.</p>
<p>This implementation is much faster than the ‘naive’ implementation
above:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="op">%</span>timeit calc_pi_numpy(<span class="dv">10</span><span class="op">**</span><span class="dv">6</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>25.2 ms ± 1.54 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)</code></pre>
</div>
<div id="discussion-is-this-all-better" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="discussion-is-this-all-better" class="callout-inner">
<h3 class="callout-title">Discussion: is this all better?</h3>
<div class="callout-content">
<p>What is the downside of the vectorized implementation? - It uses more
memory. - It is less intuitive. - It is a more monolithic approach,
i.e., you cannot break it up in several parts.</p>
</div>
</div>
</div>
<div id="challenge-daskify" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-daskify" class="callout-inner">
<h3 class="callout-title">Challenge: Daskify</h3>
<div class="callout-content">
<p>Write <code>calc_pi_dask</code> to make the Numpy version parallel.
Compare its speed and memory performance with the Numpy version. NB:
Remember that the API of <code>dask.array</code> mimics that of the
Numpy.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="im">import</span> dask.array <span class="im">as</span> da</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="kw">def</span> calc_pi_dask(N):</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>    <span class="co"># Simulate impact coordinates</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>    pts <span class="op">=</span> da.random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, (<span class="dv">2</span>, N))</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>    <span class="co"># Count number of impacts inside the circle</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>    M <span class="op">=</span> da.count_nonzero((pts<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>) <span class="op">&lt;</span> <span class="dv">1</span>)</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">4</span> <span class="op">*</span> M <span class="op">/</span> N</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="op">%</span>timeit calc_pi_dask(<span class="dv">10</span><span class="op">**</span><span class="dv">6</span>).compute()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>4.68 ms ± 135 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="using-numba-to-accelerate-python-code">Using Numba to accelerate Python code<a class="anchor" aria-label="anchor" href="#using-numba-to-accelerate-python-code"></a>
</h1>
<p>Numba makes it easier to create accelerated functions. You can
activate it with the decorator <code>numba.jit</code>.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="im">import</span> numba</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="at">@numba.jit</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="kw">def</span> sum_range_numba(a):</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>    <span class="co">"""Compute the sum of the numbers in the range [0, a)."""</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>    x <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(a):</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>        x <span class="op">+=</span> i</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>    <span class="cf">return</span> x</span></code></pre>
</div>
<p>Let’s time three versions of the same test. First, native Python
iterators:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="op">%</span>timeit <span class="bu">sum</span>(<span class="bu">range</span>(<span class="dv">10</span><span class="op">**</span><span class="dv">7</span>))</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>190 ms ± 3.26 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)</code></pre>
</div>
<p>Second, with Numpy:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="op">%</span>timeit np.arange(<span class="dv">10</span><span class="op">**</span><span class="dv">7</span>).<span class="bu">sum</span>()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>17.5 ms ± 138 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)</code></pre>
</div>
<p>Third, with Numba:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="op">%</span>timeit sum_range_numba(<span class="dv">10</span><span class="op">**</span><span class="dv">7</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>162 ns ± 0.885 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)</code></pre>
</div>
<p>Numba is hundredfold faster in this case! It gets this speedup with
“just-in-time” compilation (JIT) — that is, compiling the Python
function into machine code just before it is called, as the
<code>@numba.jit</code> decorator indicates. Numba does not support
every Python and Numpy feature, but functions written with a for-loop
with a large number of iterates, like in our
<code>sum_range_numba()</code>, are good candidates.</p>
<div id="just-in-time-compilation-speedup" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="just-in-time-compilation-speedup" class="callout-inner">
<h3 class="callout-title">Just-in-time compilation speedup</h3>
<div class="callout-content">
<p>The first time you call a function decorated with
<code>@numba.jit</code>, you may see no or little speedup. The function
can then be much faster in subsequent calls. Also, <code>timeit</code>
may throw this warning:</p>
<p><code>The slowest run took 14.83 times longer than the fastest. This could mean that an intermediate result is being cached.</code></p>
<p>Why does this happen? On the first call, the JIT compiler needs to
compile the function. On subsequent calls, it reuses the function
previously compiled. The compiled function can <em>only</em> be reused
if the types of its arguments (int, float, and the like) are the same as
at the point of compilation.</p>
<p>See this example, where <code>sum_range_numba</code> is timed once
again with a float argument instead of an int:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="op">%</span>time sum_range_numba(<span class="dv">10</span><span class="op">**</span><span class="dv">7</span>)</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="op">%</span>time sum_range_numba(<span class="fl">10.</span><span class="op">**</span><span class="dv">7</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>CPU times: user 58.3 ms, sys: 3.27 ms, total: 61.6 ms
Wall time: 60.9 ms
CPU times: user 5 µs, sys: 0 ns, total: 5 µs
Wall time: 7.87 µs</code></pre>
</div>
</div>
</div>
</div>
<div id="challenge-numbify-calc_pi" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-numbify-calc_pi" class="callout-inner">
<h3 class="callout-title">Challenge: Numbify <code>calc_pi</code>
</h3>
<div class="callout-content">
<p>Create a Numba version of <code>calc_pi</code>. Time it.</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<p>Add the <code>@numba.jit</code> decorator to the first ‘naive’
implementation.</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="at">@numba.jit</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="kw">def</span> calc_pi_numba(N):</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>    M <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>        <span class="co"># Simulate impact coordinates</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>        x <span class="op">=</span> random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>        y <span class="op">=</span> random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>        <span class="co"># True if impact happens inside the circle</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>        <span class="cf">if</span> x<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> y<span class="op">**</span><span class="dv">2</span> <span class="op">&lt;</span> <span class="fl">1.0</span>:</span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>            M <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">4</span> <span class="op">*</span> M <span class="op">/</span> N</span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a><span class="op">%</span>timeit calc_pi_numba(<span class="dv">10</span><span class="op">**</span><span class="dv">6</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>13.5 ms ± 634 µs per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="measuring-knowing" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="measuring-knowing" class="callout-inner">
<h3 class="callout-title">Measuring = knowing</h3>
<div class="callout-content">
<p>Always profile your code to see which parallelization method works
best.</p>
</div>
</div>
</div>
<div id="numba.jit-is-not-a-magical-command-to-solve-your-problems" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="numba.jit-is-not-a-magical-command-to-solve-your-problems" class="callout-inner">
<h3 class="callout-title">
<code>numba.jit</code> is not a magical
command to solve your problems</h3>
<div class="callout-content">
<p>Accelerating your code with Numba often outperforms other methods,
but rewriting code to reap the benefits of Numba is not always
trivial.</p>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Always profile your code to see which parallelization method works
best.</li>
<li>Vectorized algorithms are both a blessing and a curse.</li>
<li>Numba can help you speed up code.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div></section><section id="aio-threads-and-processes"><p>Content from <a href="threads-and-processes.html">Threads And Processes</a></p>
<hr>
<p>Last updated on 2025-03-31 |

        <a href="https://example.com/template-source/edit/main/episodes/threads-and-processes.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 90 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What is the Global Interpreter Lock (GIL)?</li>
<li>How do I use multiple threads in Python?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Understand the GIL.</li>
<li>Understand the difference between the <code>threading</code> and
<code>multiprocessing</code> libraries in Python.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="threading">Threading<a class="anchor" aria-label="anchor" href="#threading"></a>
</h1>
<p>Another possibility of parallelizing code is to use the
<code>threading</code> module. This module is built into Python. We will
use it to estimate <span class="math inline">\(\pi\)</span> once again
in this section.</p>
<p>An example of using threading to speed up your code is:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">from</span> threading <span class="im">import</span> (Thread)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">10</span><span class="op">**</span><span class="dv">7</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>t1 <span class="op">=</span> Thread(target<span class="op">=</span>calc_pi, args<span class="op">=</span>(n,))</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>t2 <span class="op">=</span> Thread(target<span class="op">=</span>calc_pi, args<span class="op">=</span>(n,))</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>t1.start()</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>t2.start()</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>t1.join()</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>t2.join()</span></code></pre>
</div>
<div id="discussion-wheres-the-speed-up" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="discussion-wheres-the-speed-up" class="callout-inner">
<h3 class="callout-title">Discussion: where’s the speed-up?</h3>
<div class="callout-content">
<p>While mileage may vary, parallelizing <code>calc_pi</code>,
<code>calc_pi_numpy</code> and <code>calc_pi_numba</code> in this way
will not give the theoretical speed-up. <code>calc_pi_numba</code>
should give <em>some</em> speed-up, but nowhere near the ideal scaling
for the number of cores. This is because, at any given time, Python only
allows a single thread to access the interpreter, a feature also known
as the Global Interpreter Lock.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="a-few-words-about-the-global-interpreter-lock">A few words about the Global Interpreter Lock<a class="anchor" aria-label="anchor" href="#a-few-words-about-the-global-interpreter-lock"></a>
</h2>
<p>The Global Interpreter Lock (GIL) is an infamous feature of the
Python interpreter. It both guarantees inner thread sanity, making
programming in Python safer, and prevents us from using multiple cores
from a single Python instance. This becomes an obvious problem when we
want to perform parallel computations. Roughly speaking, there are two
classes of solutions to circumvent/lift the GIL:</p>
<ul>
<li>Run multiple Python instances using
<code>multiprocessing</code>.</li>
<li>Keep important code outside Python using OS operations, C++
extensions, Cython, Numba.</li>
</ul>
<p>The downside of running multiple Python instances is that we need to
share the program state between different processes. To this end, you
need to serialize objects. Serialization entails converting a Python
object into a stream of bytes that can then be sent to the other process
or, for example, stored to disk. This is typically done using
<code>pickle</code>, <code>json</code>, or similar, and creates a large
overhead. The alternative is to bring parts of our code outside Python.
Numpy has many routines that are largely situated outside of the GIL.
Trying out and profiling your application is the only way to know for
sure.</p>
<p>There are several options to make your own routines not subjected to
the GIL: fortunately, <code>numba</code> makes this very easy.</p>
<p>We can unlock the GIL in Numba code by setting
<code>nogil=True</code> inside the <code>numba.jit</code> decorator:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="at">@numba.jit</span>(nopython<span class="op">=</span><span class="va">True</span>, nogil<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="kw">def</span> calc_pi_nogil(N):</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>    M <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>        x <span class="op">=</span> random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>        y <span class="op">=</span> random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>        <span class="cf">if</span> x<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> y<span class="op">**</span><span class="dv">2</span> <span class="op">&lt;</span> <span class="dv">1</span>:</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>            M <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">4</span> <span class="op">*</span> M <span class="op">/</span> N</span></code></pre>
</div>
<p>The <code>nopython</code> argument forces Numba to compile the code
without referencing any Python objects, while the <code>nogil</code>
argument disables the GIL during the execution of the function.</p>
<div id="use-nopythontrue-or-numba.njit" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="use-nopythontrue-or-numba.njit" class="callout-inner">
<h3 class="callout-title">Use <code>nopython=True</code> or
<code>@numba.njit</code>
</h3>
<div class="callout-content">
<p>It is generally good practice to use <code>nopython=True</code> with
<code>@numba.jit</code> to make sure the entire function is running
without referencing Python objects, because that will dramatically slow
down most Numba code. The decorator <code>@numba.njit</code> even has
<code>nopython=True</code> by default.</p>
</div>
</div>
</div>
<p>Now we can run the benchmark again, using <code>calc_pi_nogil</code>
instead of <code>calc_pi</code>.</p>
<div id="exercise-try-threading-on-a-numpy-function" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="exercise-try-threading-on-a-numpy-function" class="callout-inner">
<h3 class="callout-title">Exercise: try threading on a Numpy function</h3>
<div class="callout-content">
<p>Many Numpy functions unlock the GIL. Try and sort two randomly
generated arrays using <code>numpy.sort</code> in parallel.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">10</span><span class="op">**</span><span class="dv">7</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>rnd1 <span class="op">=</span> np.random.random(n)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>rnd2 <span class="op">=</span> np.random.random(n)</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="op">%</span>timeit <span class="op">-</span>n <span class="dv">10</span> <span class="op">-</span>r <span class="dv">10</span> np.sort(rnd1)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="op">%%</span>timeit <span class="op">-</span>n <span class="dv">10</span> <span class="op">-</span>r <span class="dv">10</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>t1 <span class="op">=</span> Thread(target<span class="op">=</span>np.sort, args<span class="op">=</span>(rnd1, ))</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>t2 <span class="op">=</span> Thread(target<span class="op">=</span>np.sort, args<span class="op">=</span>(rnd2, ))</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>t1.start()</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>t2.start()</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>t1.join()</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>t2.join()</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="multiprocessing">Multiprocessing<a class="anchor" aria-label="anchor" href="#multiprocessing"></a>
</h1>
<p>Python also enables parallelisation with multiple processes via the
<code>multiprocessing</code> module. It implements an API that is
superficially similar to threading:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="im">from</span> multiprocessing <span class="im">import</span> Process</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co"># function in plain Python</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="kw">def</span> calc_pi(N):</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>    M <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>        <span class="co"># Simulate impact coordinates</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>        x <span class="op">=</span> random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>        y <span class="op">=</span> random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>        <span class="co"># True if impact happens inside the circle</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>        <span class="cf">if</span> x<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> y<span class="op">**</span><span class="dv">2</span> <span class="op">&lt;</span> <span class="fl">1.0</span>:</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>            M <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>    <span class="cf">return</span> (<span class="dv">4</span> <span class="op">*</span> M <span class="op">/</span> N, N)  <span class="co"># result, iterations</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>    n <span class="op">=</span> <span class="dv">10</span><span class="op">**</span><span class="dv">7</span></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>    p1 <span class="op">=</span> Process(target<span class="op">=</span>calc_pi, args<span class="op">=</span>(n,))</span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>    p2 <span class="op">=</span> Process(target<span class="op">=</span>calc_pi, args<span class="op">=</span>(n,))</span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>    p1.start()</span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a>    p2.start()</span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a>    p1.join()</span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a>    p2.join()</span></code></pre>
</div>
<p>However, under the hood, processes are very different from threads. A
new process is created by generating a fresh “copy” of the Python
interpreter that includes all the resources associated to the parent.
There are three different ways of doing this (<em>spawn</em>,
<em>fork</em>, and <em>forkserver</em>), whose availability depends on
the platform. We will use <em>spawn</em> as it is available on all
platforms. You can read more about the others in the <a href="https://docs.python.org/3/library/multiprocessing.html#contexts-and-start-methods" class="external-link">Python
documentation</a>. Since creating a process is resource-intensive,
multiprocessing is beneficial under limited circumstances — namely, when
the resource utilisation (or runtime) of a function is
<em>measureably</em> larger than the overhead of creating a new
process.</p>
<div id="protect-process-creation-with-an-if-block" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="protect-process-creation-with-an-if-block" class="callout-inner">
<h3 class="callout-title">Protect process creation with an
<code>if</code>-block</h3>
<div class="callout-content">
<p>A module should be safely importable. Any code that creates
processes, pools, or managers should be protected with:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    ...</span></code></pre>
</div>
</div>
</div>
</div>
<p>The non-intrusive and safe way of starting a new process is to
acquire a <code>context</code> and work within that context. This
ensures that your application does not interfere with any other
processes that might be in use:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="im">import</span> multiprocessing <span class="im">as</span> mp</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="kw">def</span> calc_pi(N):</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>    ...</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>    <span class="co"># mp.set_start_method("spawn")  # if not using a context</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>    ctx <span class="op">=</span> mp.get_context(<span class="st">"spawn"</span>)</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>	...</span></code></pre>
</div>
<div class="section level2">
<h2 id="passing-objects-and-sharing-state">Passing objects and sharing state<a class="anchor" aria-label="anchor" href="#passing-objects-and-sharing-state"></a>
</h2>
<p>We can pass objects between processes by using <code>Queue</code>s
and <code>Pipe</code>s. Multiprocessing queues behave similarly to
regular queues: - FIFO: first in, first out. -
<code>queue_instance.put(&lt;obj&gt;)</code> to add. -
<code>queue_instance.get()</code> to retrieve.</p>
<div id="exercise-reimplement-calc_pi-to-use-a-queue-to-return-the-result" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="exercise-reimplement-calc_pi-to-use-a-queue-to-return-the-result" class="callout-inner">
<h3 class="callout-title">Exercise: reimplement <code>calc_pi</code> to
use a queue to return the result</h3>
<div class="callout-content">

</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="im">import</span> multiprocessing <span class="im">as</span> mp</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="kw">def</span> calc_pi(N, que):</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>    M <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>        <span class="co"># Simulate impact coordinates</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>        x <span class="op">=</span> random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>        y <span class="op">=</span> random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>        <span class="co"># True if impact happens inside the circle</span></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>        <span class="cf">if</span> x<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> y<span class="op">**</span><span class="dv">2</span> <span class="op">&lt;</span> <span class="fl">1.0</span>:</span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>            M <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>    que.put((<span class="dv">4</span> <span class="op">*</span> M <span class="op">/</span> N, N))  <span class="co"># result, iterations</span></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>    ctx <span class="op">=</span> mp.get_context(<span class="st">"spawn"</span>)</span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>    que <span class="op">=</span> ctx.Queue()</span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a>    n <span class="op">=</span> <span class="dv">10</span><span class="op">**</span><span class="dv">7</span></span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a>    p1 <span class="op">=</span> ctx.Process(target<span class="op">=</span>calc_pi, args<span class="op">=</span>(n, que))</span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a>    p2 <span class="op">=</span> ctx.Process(target<span class="op">=</span>calc_pi, args<span class="op">=</span>(n, que))</span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a></span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a>    p1.start()</span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a>    p2.start()</span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a>        <span class="bu">print</span>(que.get())</span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a></span>
<span id="cb9-33"><a href="#cb9-33" tabindex="-1"></a>    p1.join()</span>
<span id="cb9-34"><a href="#cb9-34" tabindex="-1"></a>    p2.join()</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="sharing-state" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="sharing-state" class="callout-inner">
<h3 class="callout-title">Sharing state</h3>
<div class="callout-content">
<p>It is also possible to share state between processes. The simplest
way is to use shared memory via <code>Value</code> or
<code>Array</code>. You can access the underlying value using the
<code>.value</code> property. Note, you should explicitly acquire a lock
before performing an operation that is not atomic (which cannot be done
in one step, e.g., using the <code>+=</code> operator):</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="cf">with</span> var.get_lock():</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>    var.value <span class="op">+=</span> <span class="dv">1</span></span></code></pre>
</div>
<p>Since Python 3.8, you can also create a Numpy array backed by a
shared memory buffer (<a href="https://docs.python.org/3/library/multiprocessing.shared_memory.html" class="external-link"><code>multiprocessing.shared_memory.SharedMemory</code></a>),
which can then be accessed from separate processes <em>by name</em>
(including from separate interactive shells!).</p>
</div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="process-pool">Process pool<a class="anchor" aria-label="anchor" href="#process-pool"></a>
</h2>
<p>The <code>Pool</code> API provides a pool of worker processes that
can execute tasks. Methods of the <code>Pool</code> object offer various
convenient ways to implement data parallelism in your program. The most
convenient way to create a pool object is with a context manager, either
using the toplevel function <code>multiprocessing.Pool</code>, or by
calling the <code>.Pool()</code> method on the context. With the
<code>Pool</code> object, tasks can be submitted by calling methods like
<code>.apply()</code>, <code>.map()</code>, <code>.starmap()</code>, or
their <code>.*_async()</code> versions.</p>
<div id="exercise-adapt-the-original-exercise-to-submit-tasks-to-a-pool" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="exercise-adapt-the-original-exercise-to-submit-tasks-to-a-pool" class="callout-inner">
<h3 class="callout-title">Exercise: adapt the original exercise to submit tasks to a pool</h3>
<div class="callout-content">
<ul>
<li>Use the original <code>calc_pi</code> function (without the
queue).</li>
<li>Submit batches of different sample size (different values of
<code>N</code>).</li>
<li>As mentioned earlier, creating a new process entails overheads. Try
a wide range of sample sizes and check if the runtime scales in keeping
with that claim.</li>
</ul>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> repeat</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="im">import</span> multiprocessing <span class="im">as</span> mp</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="im">from</span> timeit <span class="im">import</span> timeit</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="kw">def</span> calc_pi(N):</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>    M <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>        <span class="co"># Simulate impact coordinates</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>        x <span class="op">=</span> random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>        y <span class="op">=</span> random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>        <span class="co"># True if impact happens inside the circle</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>        <span class="cf">if</span> x<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> y<span class="op">**</span><span class="dv">2</span> <span class="op">&lt;</span> <span class="fl">1.0</span>:</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>            M <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>    <span class="cf">return</span> (<span class="dv">4</span> <span class="op">*</span> M <span class="op">/</span> N, N)  <span class="co"># result, iterations</span></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a><span class="kw">def</span> submit(ctx, N):</span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>    <span class="cf">with</span> ctx.Pool() <span class="im">as</span> pool:</span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a>        pool.starmap(calc_pi, repeat((N,), <span class="dv">4</span>))</span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a>    ctx <span class="op">=</span> mp.get_context(<span class="st">"spawn"</span>)</span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> (<span class="dv">1_000</span>, <span class="dv">100_000</span>, <span class="dv">10_000_000</span>):</span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a>        res <span class="op">=</span> timeit(<span class="kw">lambda</span>: submit(ctx, i), number<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a>        <span class="bu">print</span>(i, res)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>If we want the most efficient parallelism on a single machine, we
need to work around the GIL.</li>
<li>If your code disables the GIL, threading will be more efficient than
multiprocessing.</li>
<li>If your code keeps the GIL, some of your code is still in Python and
you are wasting precious compute time!</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div>
</div></section><section id="aio-delayed-evaluation"><p>Content from <a href="delayed-evaluation.html">Delayed Evaluation</a></p>
<hr>
<p>Last updated on 2025-03-31 |

        <a href="https://example.com/template-source/edit/main/episodes/delayed-evaluation.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 12 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What abstractions does Dask offer?</li>
<li>How can I paralellize existing Python code?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Understand the abstraction of delayed evaluation.</li>
<li>Use the <code>visualize</code> method to create dependency
graphs.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p><a href="https://dask.org/" class="external-link">Dask</a> is one of many convenient tools
available for parallelizing Python code. We have seen a basic example of
<code>dask.array</code> in a previous episode. Now, we will focus on the
<code>delayed</code> and <code>bag</code> sub-modules. Dask has other
useful components that we do not cover in this lesson, such as
<code>dataframe</code> and <code>futures</code>.</p>
<p>See an overview below:</p>
<table class="table">
<colgroup>
<col width="20%">
<col width="25%">
<col width="43%">
<col width="10%">
</colgroup>
<thead><tr class="header">
<th align="left">Dask module</th>
<th align="left">Abstraction</th>
<th align="left">Keywords</th>
<th align="left">Covered</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><code>dask.array</code></td>
<td align="left"><code>numpy</code></td>
<td align="left">Numerical analysis</td>
<td align="left">✔️</td>
</tr>
<tr class="even">
<td align="left"><code>dask.bag</code></td>
<td align="left"><code>itertools</code></td>
<td align="left">Map-reduce, workflows</td>
<td align="left">✔️</td>
</tr>
<tr class="odd">
<td align="left"><code>dask.delayed</code></td>
<td align="left">functions</td>
<td align="left">Anything that doesn’t fit the above</td>
<td align="left">✔️</td>
</tr>
<tr class="even">
<td align="left"><code>dask.dataframe</code></td>
<td align="left"><code>pandas</code></td>
<td align="left">Generic data analysis</td>
<td align="left">❌</td>
</tr>
<tr class="odd">
<td align="left"><code>dask.futures</code></td>
<td align="left"><code>concurrent.futures</code></td>
<td align="left">Control execution, low-level</td>
<td align="left">❌</td>
</tr>
</tbody>
</table>
<div class="section level1">
<h1 id="dask-delayed">Dask Delayed<a class="anchor" aria-label="anchor" href="#dask-delayed"></a>
</h1>
<p>A lot of the functionalities in Dask are based on an important
concept known as <em>delayed evaluation</em>. Hence we go a bit deeper
into <code>dask.delayed</code>.</p>
<p><code>dask.delayed</code> changes the strategy by which our
computation is evaluated. Normally, you expect that a computer runs
commands when you ask for them, and that you can give the next command
when the current job is complete. With delayed evaluation we do not wait
before formulating the next command. Instead, we create the dependency
graph of our complete computation without actually doing any work. Once
we build the full dependency graph, we can see which jobs can be done in
parallel and have those scheduled to different workers.</p>
<p>To express a computation in this world, we need to handle future
objects <em>as if they’re already there</em>. These objects may be
referred to as either <em>futures</em> or <em>promises</em>.</p>
<div id="callout1" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>Several Python libraries provide slightly different support for
working with futures. The main difference between Python futures and
Dask-delayed objects is that futures are added to a queue at the point
of definition, while delayed objects are silent until you ask to
compute. We will refer to such ‘live’ futures as futures proper, and to
‘dead’ futures (including the delayed) as <strong>promises</strong>.</p>
</div>
</div>
</div>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">from</span> dask <span class="im">import</span> delayed</span></code></pre>
</div>
<p>The <code>delayed</code> decorator builds a dependency graph from
function calls:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="at">@delayed</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="kw">def</span> add(a, b):</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>    result <span class="op">=</span> a <span class="op">+</span> b</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>a<span class="sc">}</span><span class="ss"> + </span><span class="sc">{</span>b<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span>result<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>    <span class="cf">return</span> result</span></code></pre>
</div>
<p>A <code>delayed</code> function stores the requested function call
inside a <strong>promise</strong>. The function is not actually executed
yet, and we get a value <em>promised</em>, which can be computed
later.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>x_p <span class="op">=</span> add(<span class="dv">1</span>, <span class="dv">2</span>)</span></code></pre>
</div>
<p>We can check that <code>x_p</code> is now a <code>Delayed</code>
value:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="bu">type</span>(x_p)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[out]: dask.delayed.Delayed</code></pre>
</div>
<blockquote>
<h2 id="note-on-notation">Note on notation</h2>
<p>It is good practice to suffix with <code>_p</code> variables that are
promises. That way you keep track of promises versus immediate values.
{: .callout}</p>
</blockquote>
<p>Only when we ask to evaluate the computation do we get an output:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>x_p.compute()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>1 + 2 = 3
[out]: 3</code></pre>
</div>
<p>From <code>Delayed</code> values we can create larger workflows and
visualize them:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>x_p <span class="op">=</span> add(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>y_p <span class="op">=</span> add(x_p, <span class="dv">3</span>)</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>z_p <span class="op">=</span> add(x_p, y_p)</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>z_p.visualize(rankdir<span class="op">=</span><span class="st">"LR"</span>)</span></code></pre>
</div>
<figure><img src="../fig/dask-workflow-example.svg" class="output figure mx-auto d-block" alt="boxes and arrows"><div class="figcaption">Dask workflow graph</div>
</figure><div id="challenge-run-the-workflow" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-run-the-workflow" class="callout-inner">
<h3 class="callout-title">Challenge: run the workflow</h3>
<div class="callout-content">
<p>Given this workflow:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>x_p <span class="op">=</span> add(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>y_p <span class="op">=</span> add(x_p, <span class="dv">3</span>)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>z_p <span class="op">=</span> add(x_p, <span class="op">-</span><span class="dv">3</span>)</span></code></pre>
</div>
<p>Visualize and compute <code>y_p</code> and <code>z_p</code>
separately. How many times is <code>x_p</code> evaluated?</p>
<p>Now change the workflow:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>x_p <span class="op">=</span> add(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>y_p <span class="op">=</span> add(x_p, <span class="dv">3</span>)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>z_p <span class="op">=</span> add(x_p, y_p)</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>z_p.visualize(rankdir<span class="op">=</span><span class="st">"LR"</span>)</span></code></pre>
</div>
<p>We pass the not-yet-computed promise <code>x_p</code> to both
<code>y_p</code> and <code>z_p</code>. If you only compute
<code>z_p</code>, how many times do you expect <code>x_p</code> to be
evaluated? Run the workflow to check your answer.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>z_p.compute()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>1 + 2 = 3
3 + 3 = 6
3 + 6 = 9
[out]: 9</code></pre>
</div>
<p>The computation of <code>x_p</code> (1 + 2) appears only once. This
should convince you to procrastinate the call <code>compute</code> as
long as you can.</p>
</div>
</div>
</div>
</div>
<p>We can also make a promise by directly calling
<code>delayed</code>:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">10</span><span class="op">**</span><span class="dv">7</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>x_p <span class="op">=</span> delayed(calc_pi)(N)</span></code></pre>
</div>
<p>It is now possible to call <code>visualize</code> or
<code>compute</code> methods on <code>x_p</code>.</p>
<div id="decorators" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="decorators" class="callout-inner">
<h3 class="callout-title">Decorators</h3>
<div class="callout-content">
<p>In Python the decorator syntax is equivalent to passing a function
through a function adapter, also known as a higher order function or a
functional. This adapter can change the behaviour of the function in
many ways. The statement</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="at">@delayed</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="kw">def</span> sqr(x):</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">*</span>x</span></code></pre>
</div>
<p>is functionally equivalent to:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="kw">def</span> sqr(x):</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">*</span>x</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>sqr <span class="op">=</span> delayed(sqr)</span></code></pre>
</div>
</div>
</div>
</div>
<div id="variadic-arguments" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="variadic-arguments" class="callout-inner">
<h3 class="callout-title">Variadic arguments</h3>
<div class="callout-content">
<p>In Python you can define functions taking arbitrary number of
arguments:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="kw">def</span> add(<span class="op">*</span>args):</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a> <span class="cf">return</span> <span class="bu">sum</span>(args)</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>add(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>)   <span class="co"># =&gt; 10</span></span></code></pre>
</div>
<p>You can then use tuple-unpacking to pass a sequence of arguments:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>numbers <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>]</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>add(<span class="op">*</span>numbers)   <span class="co"># =&gt; 10</span></span></code></pre>
</div>
</div>
</div>
</div>
<p>We can build new primitives from the ground up. An important function
that is found frequently where non-standard evaluation strategies are
involved is <code>gather</code>. We can implement <code>gather</code> as
follows:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="at">@delayed</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="kw">def</span> gather(<span class="op">*</span>args):</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">list</span>(args)</span></code></pre>
</div>
<div id="challenge-understand-gather" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-understand-gather" class="callout-inner">
<h3 class="callout-title">Challenge: understand <code>gather</code>
</h3>
<div class="callout-content">
<p>Can you describe what the <code>gather</code> function does in terms
of lists and promises? Hint: Suppose I have a list of promises, what
does <code>gather</code> enable me to do?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>It turns a list of promises into a promise of a list.</p>
</div>
</div>
</div>
</div>
<p>This small example shows what <code>gather</code> does:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>x_p <span class="op">=</span> gather(<span class="op">*</span>(delayed(add)(n, n) <span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>))) <span class="co"># Shorthand for gather(add(1, 1), add(2, 2), ...)</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>x_p.visualize()</span></code></pre>
</div>
<p><img src="../fig/dask-gather-example.svg" alt="a gather pattern" class="figure">
{.output alt=“boxes and arrows”}</p>
<p>Computing the result</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>x_p.compute()</span></code></pre>
</div>
<p>gives</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[out]: [0, 1, 4, 9, 16, 25, 36, 49, 64, 81]</code></pre>
</div>
<div id="challenge-design-a-mean-function-and-calculate-pi" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-design-a-mean-function-and-calculate-pi" class="callout-inner">
<h3 class="callout-title">Challenge: design a <code>mean</code> function
and calculate <span class="math inline">\(\pi\)</span>
</h3>
<div class="callout-content">
<p>Write a <code>delayed</code> function that computes the mean of its
arguments. Use it to estimate <span class="math inline">\(\pi\)</span>
several times and have it return the mean of the intermediate
results.</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> mean(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>).compute()</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="fl">2.5</span></span></code></pre>
</div>
<p>Make sure that the entire computation is contained in a single
promise.</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="im">from</span> dask <span class="im">import</span> delayed</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a><span class="at">@delayed</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a><span class="kw">def</span> mean(<span class="op">*</span>args):</span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sum</span>(args) <span class="op">/</span> <span class="bu">len</span>(args)</span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a><span class="kw">def</span> calc_pi(N):</span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>    <span class="co">"""Computes the value of pi using N random samples."""</span></span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a>    M <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a>        <span class="co"># take a sample</span></span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a>        x <span class="op">=</span> random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb23-14"><a href="#cb23-14" tabindex="-1"></a>        y <span class="op">=</span> random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb23-15"><a href="#cb23-15" tabindex="-1"></a>        <span class="cf">if</span> x<span class="op">*</span>x <span class="op">+</span> y<span class="op">*</span>y <span class="op">&lt;</span> <span class="fl">1.</span>: M<span class="op">+=</span><span class="dv">1</span></span>
<span id="cb23-16"><a href="#cb23-16" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">4</span> <span class="op">*</span> M <span class="op">/</span> N</span>
<span id="cb23-17"><a href="#cb23-17" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">10</span><span class="op">**</span><span class="dv">6</span></span>
<span id="cb23-20"><a href="#cb23-20" tabindex="-1"></a>pi_p <span class="op">=</span> mean(<span class="op">*</span>(delayed(calc_pi)(N) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>)))</span>
<span id="cb23-21"><a href="#cb23-21" tabindex="-1"></a>pi_p.compute()</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>You may not see a significant speed-up. This is because
<code>dask delayed</code> uses threads by default, and our native Python
implementation of <code>calc_pi</code> does not circumvent the GIL. You
should see a more significant speed-up with the Numba version of
<code>calc_pi</code>, for example.</p>
<p>In practice, you may not need to use <code>@delayed</code> functions
frequently, but they do offer ultimate flexibility. You can build
complex computational workflows in this manner, sometimes replacing
shell scripting, make files, and suchlike.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>We can change the strategy by which a computation is evaluated.</li>
<li>Nothing is computed until we run <code>compute()</code>.</li>
<li>With delayed evaluation Dask knows which jobs can be run in
parallel.</li>
<li>Call <code>compute</code> only once at the end of your program to
get the best results.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div></section><section id="aio-map-and-reduce"><p>Content from <a href="map-and-reduce.html">Map and Reduce</a></p>
<hr>
<p>Last updated on 2025-03-31 |

        <a href="https://example.com/template-source/edit/main/episodes/map-and-reduce.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 90 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>Which abstractions does Dask offer?</li>
<li>Which programming patterns exist in the parallel universe?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Recognize <code>map</code>, <code>filter</code> and
<code>reduction</code> patterns.</li>
<li>Create programs using these building blocks.</li>
<li>Use the <code>visualize</code> method to create dependency
graphs.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>In computer science <em>bags</em> are unordered collections of data.
In Dask, a <code>bag</code> is a collection that gets chunked
internally. Operations on a bag are automatically parallelized over the
chunks inside the bag.</p>
<p>Dask bags let you compose functionality using several primitive
patterns: the most important of these are <code>map</code>,
<code>filter</code>, <code>groupby</code>, <code>flatten</code>, and
<code>reduction</code>.</p>
<div id="discussion" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="discussion" class="callout-inner">
<h3 class="callout-title">Discussion</h3>
<div class="callout-content">
<p>Open the <a href="https://docs.dask.org/en/latest/bag-api.html" class="external-link">Dask
documentation on bags</a>. Discuss the <code>map</code>,
<code>filter</code>, <code>flatten</code> and <code>reduction</code>
methods.</p>
<p>In this set of operations <code>reduction</code> is rather special,
because all operations on bags could be written in terms of a
reduction.</p>
</div>
</div>
</div>
<p>Operations on this level can be distinguished in several
categories:</p>
<ul>
<li>
<strong>map</strong> (N to N) applies a function <em>one-to-one</em>
on a list of arguments. This operation is <strong>embarrassingly
parallel</strong>.</li>
<li>
<strong>filter</strong> (N to &lt;N) selects a subset from the
data.</li>
<li>
<strong>reduction</strong> (N to 1) computes an aggregate from a
sequence of data; if the operation permits it (summing, maximizing,
etc), this can be done in parallel by reducing chunks of data and then
further processing the results of those chunks.</li>
<li>
<strong>groupby</strong> (1 bag to N bags) groups data in
subcategories.</li>
<li>
<strong>flatten</strong> (N bags to 1 bag) combine many bags into
one.</li>
</ul>
<p>Let’s see examples of them in action.</p>
<p>First, let’s create the <code>bag</code> containing the elements we
want to work with. In this case, the numbers from 0 to 5.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> dask.bag <span class="im">as</span> db</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>bag <span class="op">=</span> db.from_sequence([<span class="st">'mary'</span>, <span class="st">'had'</span>, <span class="st">'a'</span>, <span class="st">'little'</span>, <span class="st">'lamb'</span>])</span></code></pre>
</div>
<p>{: .source}</p>
<div class="section level3">
<h3 id="map">Map<a class="anchor" aria-label="anchor" href="#map"></a>
</h3>
<p>A function squaring its argument is a mapping function that
illustrates the concept of <code>map</code>:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># Create a function for mapping</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="kw">def</span> f(x):</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>    <span class="cf">return</span> x.upper()</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="co"># Create the map and compute it</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>bag.<span class="bu">map</span>(f).compute()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>out: ['MARY', 'HAD', 'A', 'LITTLE', 'LAMB']</code></pre>
</div>
<p>We can also visualize the mapping:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># Visualize the map</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>bag.<span class="bu">map</span>(f).visualize()</span></code></pre>
</div>
<figure><img src="../fig/dask-bag-map.svg" class="output figure mx-auto d-block" alt="boxes and arrows"><div class="figcaption">A map operation.</div>
</figure>
</div>
<div class="section level3">
<h3 id="filter">Filter<a class="anchor" aria-label="anchor" href="#filter"></a>
</h3>
<p>We need a predicate, that is a function returning either true or
false, to illustrate the concept of <code>filter</code>. In this case,
we use a function returning <code>True</code> if the argument contains
the letter ‘a’, and <code>False</code> if it does not.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># Return True if x contains the letter 'a', else False</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="kw">def</span> pred(x):</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">'a'</span> <span class="kw">in</span> x</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>bag.<span class="bu">filter</span>(pred).compute()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[out]: ['mary', 'had', 'a', 'lamb']</code></pre>
</div>
<div id="difference-between-filter-and-map" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="difference-between-filter-and-map" class="callout-inner">
<h3 class="callout-title">Difference between <code>filter</code> and
<code>map</code>
</h3>
<div class="callout-content">
<p>Forecast the output of <code>bag.map(pred).compute()</code> without
executing it.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>The output will be <code>[True, True, True, False, True]</code>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="reduction">Reduction<a class="anchor" aria-label="anchor" href="#reduction"></a>
</h3>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="kw">def</span> count_chars(x):</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    per_word <span class="op">=</span> [<span class="bu">len</span>(w) <span class="cf">for</span> w <span class="kw">in</span> x]</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sum</span>(per_word)</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>bag.reduction(count_chars, <span class="bu">sum</span>).visualize()</span></code></pre>
</div>
<figure><img src="../fig/dask-bag-reduction.svg" class="output figure mx-auto d-block" alt="boxes and arrows"><div class="figcaption">A reduction.</div>
</figure><div id="challenge-consider-pluck" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-consider-pluck" class="callout-inner">
<h3 class="callout-title">Challenge: consider <code>pluck</code>
</h3>
<div class="callout-content">
<p>We previously discussed some generic operations on bags. In the
documentation, lookup the <code>pluck</code> method. How would you
implement <code>pluck</code> if it was not there?</p>
<p>Hint: Try <code>pluck</code> on some example data.</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="im">from</span> dask <span class="im">import</span> bag <span class="im">as</span> db</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>data <span class="op">=</span> [</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>   { <span class="st">"name"</span>: <span class="st">"John"</span>, <span class="st">"age"</span>: <span class="dv">42</span> },</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>   { <span class="st">"name"</span>: <span class="st">"Mary"</span>, <span class="st">"age"</span>: <span class="dv">35</span> },</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>   { <span class="st">"name"</span>: <span class="st">"Paul"</span>, <span class="st">"age"</span>: <span class="dv">78</span> },</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>   { <span class="st">"name"</span>: <span class="st">"Julia"</span>, <span class="st">"age"</span>: <span class="dv">10</span> }</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>]</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>bag <span class="op">=</span> db.from_sequence(data)</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>...</span></code></pre>
</div>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>The <code>pluck</code> method is a mapping. The input is supposed to
be a bag of dictionaries.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="im">from</span> operator <span class="im">import</span> getitem</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>bag.<span class="bu">map</span>(partial(getitem, <span class="st">"name"</span>)).compute()</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>FIXME: find replacement for word counting example.</p>
<div id="challenge-dask-version-of-pi-estimation" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-dask-version-of-pi-estimation" class="callout-inner">
<h3 class="callout-title">Challenge: Dask version of Pi estimation</h3>
<div class="callout-content">
<p>Use <code>map</code> and <code>mean</code> functions on Dask bags to
compute <span class="math inline">\(\pi\)</span>.</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="im">import</span> dask.bag</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="im">from</span> numpy <span class="im">import</span> repeat</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="kw">def</span> calc_pi(N):</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>    <span class="co">"""Computes the value of pi using N random samples."""</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>    M <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>        <span class="co"># take a sample</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>        x <span class="op">=</span> random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>        y <span class="op">=</span> random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>        <span class="cf">if</span> x<span class="op">*</span>x <span class="op">+</span> y<span class="op">*</span>y <span class="op">&lt;</span> <span class="fl">1.</span>:</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>            M <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">4</span> <span class="op">*</span> M <span class="op">/</span> N</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>bag <span class="op">=</span> dask.bag.from_sequence(repeat(<span class="dv">10</span><span class="op">**</span><span class="dv">7</span>, <span class="dv">24</span>))</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>shots <span class="op">=</span> bag.<span class="bu">map</span>(calc_pi)</span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>estimate <span class="op">=</span> shots.mean()</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>estimate.compute()</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="note" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="note" class="callout-inner">
<h3 class="callout-title">Note</h3>
<div class="callout-content">
<p>By default Dask runs a bag using multiprocessing. This alleviates
problems with the GIL, but also entails a larger overhead.</p>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Use abstractions to keep programs manageable.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div></section><section id="aio-exercise-with-fractals"><p>Content from <a href="exercise-with-fractals.html">Exercise with Fractals</a></p>
<hr>
<p>Last updated on 2025-03-31 |

        <a href="https://example.com/template-source/edit/main/episodes/exercise-with-fractals.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 60 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>Can we tackle a real problem now?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Create a strategy to parallelize existing code.</li>
<li>Apply previous lessons.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="the-mandelbrot-and-julia-fractals">The Mandelbrot and Julia fractals<a class="anchor" aria-label="anchor" href="#the-mandelbrot-and-julia-fractals"></a>
</h1>
<p>This exercise uses Numpy and Matplotlib.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span></code></pre>
</div>
<p>We will be computing the famous <a href="https://en.wikipedia.org/wiki/Mandelbrot_fractal" class="external-link">Mandelbrot
fractal</a>.</p>
<div id="complex-numbers" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="complex-numbers" class="callout-inner">
<h3 class="callout-title">Complex numbers</h3>
<div class="callout-content">
<p>Complex numbers are a special representation of rotations and
scalings in the two-dimensional plane. Multiplying two complex numbers
is the same as taking a point, rotate it by an angle <span class="math inline">\(\phi\)</span> and scale it by the absolute value.
Multiplying with a number <span class="math inline">\(z \in
\mathbb{C}\)</span> by 1 preserves <span class="math inline">\(z\)</span>. Multiplying a point at <span class="math inline">\(i = (0, 1)\)</span> (having a positive angle of 90
degrees and absolute value 1), rotates it anti-clockwise by 90 degrees.
Then you might see that <span class="math inline">\(i^2 = (-1,
0)\)</span>. The funny thing is that we can treat <span class="math inline">\(i\)</span> as any ordinary number, and all our
algebra still works out. This is actually nothing short of a miracle! We
can write a complex number</p>
<p><span class="math display">\[z = x + iy,\]</span></p>
<p>remember that <span class="math inline">\(i^2 = -1\)</span>, and act
as if everything is normal!</p>
</div>
</div>
</div>
<p>The Mandelbrot set is the set of complex numbers <span class="math display">\[c \in \mathbb{C}\]</span> for which the
iteration</p>
<p><span class="math display">\[z_{n+1} = z_n^2 + c,\]</span></p>
<p>converges, starting from iteration at <span class="math inline">\(z_0
= 0\)</span>. We can visualize the Mandelbrot set by plotting the number
of iterations needed for the absolute value <span class="math inline">\(|z_n|\)</span> to exceed 2 (for which it can be
shown that the iteration always diverges).</p>
<figure><img src="../fig/mandelbrot-all.png" alt="colorful rendering of mandelbrot set" class="figure mx-auto d-block"><div class="figcaption">The whole Mandelbrot set</div>
</figure><p>We may compute the Mandelbrot as follows:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>max_iter <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>width <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>height <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>center <span class="op">=</span> <span class="op">-</span><span class="fl">0.8</span> <span class="op">+</span> <span class="ot">0.0j</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>extent <span class="op">=</span> <span class="fl">3.0</span> <span class="op">+</span> <span class="ot">3.0j</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>scale <span class="op">=</span> <span class="bu">max</span>((extent <span class="op">/</span> width).real, (extent <span class="op">/</span> height).imag)</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>result <span class="op">=</span> np.zeros((height, width), <span class="bu">int</span>)</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(height):</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(width):</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>        c <span class="op">=</span> center <span class="op">+</span> (i <span class="op">-</span> width <span class="op">//</span> <span class="dv">2</span> <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> (j <span class="op">-</span> height <span class="op">//</span> <span class="dv">2</span>)) <span class="op">*</span> scale</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>        z <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(max_iter):</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>            z <span class="op">=</span> z<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> c</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>            <span class="cf">if</span> (z <span class="op">*</span> z.conjugate()).real <span class="op">&gt;</span> <span class="fl">4.0</span>:</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>        result[j, i] <span class="op">=</span> k</span></code></pre>
</div>
<p>Then we can plot with the following code:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>plot_extent <span class="op">=</span> (width <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> height) <span class="op">*</span> scale</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>z1 <span class="op">=</span> center <span class="op">-</span> plot_extent <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>z2 <span class="op">=</span> z1 <span class="op">+</span> plot_extent</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>ax.imshow(result<span class="op">**</span>(<span class="dv">1</span> <span class="op">/</span> <span class="dv">3</span>), origin<span class="op">=</span><span class="st">'lower'</span>, extent<span class="op">=</span>(z1.real, z2.real, z1.imag, z2.imag))</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>ax.set_xlabel(<span class="st">"$\Re(c)$"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>ax.set_ylabel(<span class="st">"$\Im(c)$"</span>)</span></code></pre>
</div>
<p>Things become really loads of fun when we zoom in. We can play around
with the <code>center</code> and <code>extent</code> values, and
necessarily <code>max_iter</code>, to control our window:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>max_iter <span class="op">=</span> <span class="dv">1024</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>center <span class="op">=</span> <span class="op">-</span><span class="fl">1.1195</span> <span class="op">+</span> <span class="ot">0.2718j</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>extent <span class="op">=</span> <span class="fl">0.005</span> <span class="op">+</span> <span class="ot">0.005j</span></span></code></pre>
</div>
<p>When we zoom in on the Mandelbrot fractal, we get smaller copies of
the larger set!</p>
<figure><img src="../fig/mandelbrot-1.png" alt="rendering of mandelbrot zoom" class="figure mx-auto d-block"><div class="figcaption">Zoom in on Mandelbrot set</div>
</figure><div id="exercise" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="exercise" class="callout-inner">
<h3 class="callout-title">Exercise</h3>
<div class="callout-content">
<p>Turn this into an efficient parallel program. What kind of speed-ups
do you get?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Create a BoundingBox class
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>We start with a naive implementation. It may be convenient to define
a <code>BoundingBox</code> class in a separate module
<code>bounding_box.py</code>. We add methods to this class later on.</p>
<div class="codewrapper sourceCode" id="cb5" file="src/mandelbrot/bounding_box.py">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="im">import</span> dask.array <span class="im">as</span> da</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="kw">class</span> BoundingBox:</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>    width: <span class="bu">int</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>    height: <span class="bu">int</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>    center: <span class="bu">complex</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>    extent: <span class="bu">complex</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>    _scale: Optional[<span class="bu">float</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>    <span class="kw">def</span> scale(<span class="va">self</span>):</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>._scale <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>            <span class="va">self</span>._scale <span class="op">=</span> <span class="bu">max</span>(<span class="va">self</span>.extent.real <span class="op">/</span> <span class="va">self</span>.width,</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>                              <span class="va">self</span>.extent.imag <span class="op">/</span> <span class="va">self</span>.height)</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._scale</span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>    <span class="op">&lt;&lt;</span>bounding<span class="op">-</span>box<span class="op">-</span>methods<span class="op">&gt;&gt;</span></span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>test_case <span class="op">=</span> BoundingBox(<span class="dv">1024</span>, <span class="dv">1024</span>, <span class="op">-</span><span class="fl">1.1195</span><span class="op">+</span><span class="ot">0.2718j</span>, <span class="fl">0.005</span><span class="op">+</span><span class="ot">0.005j</span>)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Plotting function
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb6" file="src/mandelbrot/plotting.py">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="im">import</span> matplotlib  <span class="co"># type:ignore</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>matplotlib.use(backend<span class="op">=</span><span class="st">"Agg"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="im">from</span> bounding_box <span class="im">import</span> BoundingBox</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="kw">def</span> plot_fractal(box: BoundingBox, values: np.ndarray, ax<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>    <span class="cf">if</span> ax <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>        fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>        fig <span class="op">=</span> <span class="va">None</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>    plot_extent <span class="op">=</span> (box.width <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> box.height) <span class="op">*</span> box.scale</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>    z1 <span class="op">=</span> box.center <span class="op">-</span> plot_extent <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>    z2 <span class="op">=</span> z1 <span class="op">+</span> plot_extent</span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>    ax.imshow(values, origin<span class="op">=</span><span class="st">'lower'</span>, extent<span class="op">=</span>(z1.real, z2.real, z1.imag, z2.imag),</span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>              cmap<span class="op">=</span>matplotlib.colormaps[<span class="st">"viridis"</span>])</span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"$\Re(c)$"</span>)</span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"$\Im(c)$"</span>)</span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>    <span class="cf">return</span> fig, ax</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">
  Some solutions
  </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<p>The natural approach with Python is to speed this up with Numba.
Then, there are three ways to parallelize: first, letting Numba
parallelize the function; second, doing a manual domain decomposition
and using one of the many Python ways to run multi-threaded things;
third, creating a vectorized function and parallelizing it using
<code>dask.array</code>. This last option is almost always slower than
<code>@njit(parallel=True)</code> and domain decomposition.</p>
<div class="codewrapper sourceCode" id="cb7" file="src/mandelbrot/__init__.py">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4">
  Numba (serial)
  </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" data-bs-parent="#accordionSolution4" aria-labelledby="headingSolution4">
<div class="accordion-body">
<p>When we port the core Mandelbrot function to Numba, we need to keep
some best practices in mind:</p>
<ul>
<li>Don’t pass composite objects other than Numpy arrays.</li>
<li>Avoid acquiring memory inside a Numba function; rather, create an
array in Python and then pass it to the Numba function.</li>
<li>Write a Pythonic wrapper around the Numba function for easy
use.</li>
</ul>
<div class="codewrapper sourceCode" id="cb8" file="src/mandelbrot/numba_serial.py">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any, Optional</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="im">import</span> numba  <span class="co"># type:ignore</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="im">from</span> bounding_box <span class="im">import</span> BoundingBox</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="at">@numba.njit</span>(nogil<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="kw">def</span> compute_mandelbrot_numba(</span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>        result, width: <span class="bu">int</span>, height: <span class="bu">int</span>, center: <span class="bu">complex</span>,</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>        scale: <span class="bu">complex</span>, max_iter: <span class="bu">int</span>):</span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(height):</span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(width):</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>            c <span class="op">=</span> center <span class="op">+</span> (i <span class="op">-</span> width <span class="op">//</span> <span class="dv">2</span> <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> (j <span class="op">-</span> height <span class="op">//</span> <span class="dv">2</span>)) <span class="op">*</span> scale</span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>            z <span class="op">=</span> <span class="fl">0.0</span> <span class="op">+</span> <span class="ot">0.0j</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>            <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(max_iter):</span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>                z <span class="op">=</span> z<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> c</span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>                <span class="cf">if</span> (z <span class="op">*</span> z.conjugate()).real <span class="op">&gt;=</span> <span class="fl">4.0</span>:</span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>            result[j, i] <span class="op">=</span> k</span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a><span class="kw">def</span> compute_mandelbrot(</span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a>        box: BoundingBox, max_iter: <span class="bu">int</span>,</span>
<span id="cb8-26"><a href="#cb8-26" tabindex="-1"></a>        result: Optional[np.ndarray[np.int64]] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb8-27"><a href="#cb8-27" tabindex="-1"></a>        throttle: Any <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb8-28"><a href="#cb8-28" tabindex="-1"></a>    result <span class="op">=</span> result <span class="cf">if</span> result <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="op">\</span></span>
<span id="cb8-29"><a href="#cb8-29" tabindex="-1"></a>            <span class="cf">else</span> np.zeros((box.height, box.width), np.int64)</span>
<span id="cb8-30"><a href="#cb8-30" tabindex="-1"></a>    <span class="cf">return</span> compute_mandelbrot_numba(</span>
<span id="cb8-31"><a href="#cb8-31" tabindex="-1"></a>        result, box.width, box.height, box.center, box.scale,</span>
<span id="cb8-32"><a href="#cb8-32" tabindex="-1"></a>        max_iter<span class="op">=</span>max_iter)</span></code></pre>
</div>
<div class="section level3">
<h3 id="numba-paralleltrue">Numba <code>parallel=True</code>
<a class="anchor" aria-label="anchor" href="#numba-paralleltrue"></a>
</h3>
<p>We can parallelize loops directly with Numba. Pass the flag
<code>parallel=True</code> and use <code>prange</code> to create the
loop. Here, it is even more important to obtain the result array outside
the context of Numba, otherwise the result will be slower than the
serial version.</p>
<div class="codewrapper sourceCode" id="cb9" file="src/mandelbrot/numba_parallel.py">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="im">import</span> numba  <span class="co"># type:ignore</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="im">from</span> numba <span class="im">import</span> prange  <span class="co"># type:ignore</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="im">from</span> .bounding_box <span class="im">import</span> BoundingBox</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="at">@numba.njit</span>(nogil<span class="op">=</span><span class="va">True</span>, parallel<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a><span class="kw">def</span> compute_mandelbrot_numba(</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>        result, width: <span class="bu">int</span>, height: <span class="bu">int</span>, center: <span class="bu">complex</span>, scale: <span class="bu">complex</span>,</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>        max_iter: <span class="bu">int</span>):</span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> prange(height):</span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> prange(width):</span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>            c <span class="op">=</span> center <span class="op">+</span> (i <span class="op">-</span> width <span class="op">//</span> <span class="dv">2</span> <span class="op">+</span> (j <span class="op">-</span> height <span class="op">//</span> <span class="dv">2</span>) <span class="op">*</span> <span class="ot">1j</span>) <span class="op">*</span> scale</span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>            z <span class="op">=</span> <span class="fl">0.0</span><span class="op">+</span><span class="ot">0.0j</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>            <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(max_iter):</span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>                z <span class="op">=</span> z<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> c</span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>                <span class="cf">if</span> (z<span class="op">*</span>z.conjugate()).real <span class="op">&gt;=</span> <span class="fl">4.0</span>:</span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>            result[j, i] <span class="op">=</span> k</span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a><span class="kw">def</span> compute_mandelbrot(box: BoundingBox, max_iter: <span class="bu">int</span>,</span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a>                       throttle: Optional[<span class="bu">int</span>] <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a>    <span class="cf">if</span> throttle <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a>        numba.set_num_threads(throttle)</span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a>    result <span class="op">=</span> np.zeros((box.height, box.width), np.int64)</span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a>    <span class="cf">return</span> compute_mandelbrot_numba(</span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a>        result, box.width, box.height, box.center, box.scale,</span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a>        max_iter<span class="op">=</span>max_iter)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="accordionSolution5" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution5" aria-expanded="false" aria-controls="collapseSolution5">
  <h4 class="accordion-header" id="headingSolution5">
  Domain splitting
  </h4>
</button>
<div id="collapseSolution5" class="accordion-collapse collapse" data-bs-parent="#accordionSolution5" aria-labelledby="headingSolution5">
<div class="accordion-body">
<p>We split the computation into a set of sub-domains. The
<code>BoundingBox.split()</code> method is designed so that, if we
deep-map the resulting list-of-lists, we can recombine the results using
<code>numpy.block()</code>.</p>
<div class="codewrapper sourceCode" id="bounding-box-methods">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="bounding-box-methods-1"><a href="#bounding-box-methods-1" tabindex="-1"></a><span class="kw">def</span> split(<span class="va">self</span>, n):</span>
<span id="bounding-box-methods-2"><a href="#bounding-box-methods-2" tabindex="-1"></a>    <span class="co">"""Split the domain in nxn subdomains, and return a grid of BoundingBoxes."""</span></span>
<span id="bounding-box-methods-3"><a href="#bounding-box-methods-3" tabindex="-1"></a>    w <span class="op">=</span> <span class="va">self</span>.width <span class="op">//</span> n</span>
<span id="bounding-box-methods-4"><a href="#bounding-box-methods-4" tabindex="-1"></a>    h <span class="op">=</span> <span class="va">self</span>.height <span class="op">//</span> n</span>
<span id="bounding-box-methods-5"><a href="#bounding-box-methods-5" tabindex="-1"></a>    e <span class="op">=</span> <span class="va">self</span>.scale <span class="op">*</span> w <span class="op">+</span> <span class="va">self</span>.scale <span class="op">*</span> h <span class="op">*</span> <span class="ot">1j</span></span>
<span id="bounding-box-methods-6"><a href="#bounding-box-methods-6" tabindex="-1"></a>    x0 <span class="op">=</span> <span class="va">self</span>.center <span class="op">-</span> e <span class="op">*</span> (n <span class="op">/</span> <span class="dv">2</span> <span class="op">-</span> <span class="fl">0.5</span>)</span>
<span id="bounding-box-methods-7"><a href="#bounding-box-methods-7" tabindex="-1"></a>    <span class="cf">return</span> [[BoundingBox(w, h, x0 <span class="op">+</span> i <span class="op">*</span> e.real <span class="op">+</span> j <span class="op">*</span> e.imag <span class="op">*</span> <span class="ot">1j</span>, e)</span>
<span id="bounding-box-methods-8"><a href="#bounding-box-methods-8" tabindex="-1"></a>             <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n)]</span>
<span id="bounding-box-methods-9"><a href="#bounding-box-methods-9" tabindex="-1"></a>            <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(n)]</span></code></pre>
</div>
<p>To perform the computation in parallel, let’s go ahead and choose the
most difficult path: <code>asyncio</code>. There are other ways to do
this, like setting up a number of threads or using Dask. However,
<code>asyncio</code> is available in Python natively. In the end, the
result is very similar to what we would get using
<code>dask.delayed</code>.</p>
<p>This may seem as a lot of code, but remember: we only use Numba to
compile the core part and then Asyncio to parallelize. The progress bar
is a bit of flutter and the semaphore is only there to throttle the
computation to fewer cores. Even then, this solution is the most
extensive by far but also the fastest.</p>
<div class="codewrapper sourceCode" id="cb10" file="src/mandelbrot/domain_splitting.py">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="im">from</span> psutil <span class="im">import</span> cpu_count  <span class="co"># type:ignore</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="im">from</span> contextlib <span class="im">import</span> nullcontext</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="im">from</span> .bounding_box <span class="im">import</span> BoundingBox</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="im">from</span> .numba_serial <span class="im">import</span> compute_mandelbrot <span class="im">as</span> mandelbrot_serial</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> a_compute_mandelbrot(</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>        box: BoundingBox,</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>        max_iter: <span class="bu">int</span>,</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>        semaphore: Optional[asyncio.Semaphore]):</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> semaphore <span class="kw">or</span> nullcontext():</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>        result <span class="op">=</span> np.zeros((box.height, box.width), np.int64)</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>        <span class="cf">await</span> asyncio.to_thread(</span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>                mandelbrot_serial, box, max_iter, result<span class="op">=</span>result)</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> a_domain_split(box: BoundingBox, max_iter: <span class="bu">int</span>,</span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>                         sem: Optional[asyncio.Semaphore]):</span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>    n_cpus <span class="op">=</span> cpu_count(logical<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>    split <span class="op">=</span> box.split(n_cpus)</span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>    split_result <span class="op">=</span> <span class="cf">await</span> asyncio.gather(</span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a>        <span class="op">*</span>(asyncio.gather(</span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>            <span class="op">*</span>(a_compute_mandelbrot(b, max_iter, sem)</span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a>              <span class="cf">for</span> b <span class="kw">in</span> row))</span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a>          <span class="cf">for</span> row <span class="kw">in</span> split))</span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a>    <span class="cf">return</span> np.block(split_result)</span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a></span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a><span class="kw">def</span> compute_mandelbrot(box: BoundingBox, max_iter: <span class="bu">int</span>,</span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a>                       throttle: Optional[<span class="bu">int</span>] <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a>    sem <span class="op">=</span> asyncio.Semaphore(throttle) <span class="cf">if</span> throttle <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a>    <span class="cf">return</span> asyncio.run(a_domain_split(box, max_iter, sem))</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="accordionSolution6" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution6" aria-expanded="false" aria-controls="collapseSolution6">
  <h4 class="accordion-header" id="headingSolution6">
  Numba vectorize
  </h4>
</button>
<div id="collapseSolution6" class="accordion-collapse collapse" data-bs-parent="#accordionSolution6" aria-labelledby="headingSolution6">
<div class="accordion-body">
<p>Another solution is to use Numba’s <code>@guvectorize</code>
decorator. The speed-up (on my machine) is not as dramatic as with the
domain decomposition, though.</p>
<div class="codewrapper sourceCode" id="bounding-box-methods">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="bounding-box-methods-1"><a href="#bounding-box-methods-1" tabindex="-1"></a><span class="kw">def</span> grid(<span class="va">self</span>):</span>
<span id="bounding-box-methods-2"><a href="#bounding-box-methods-2" tabindex="-1"></a>    <span class="co">"""Return the complex values on the grid in a 2d array."""</span></span>
<span id="bounding-box-methods-3"><a href="#bounding-box-methods-3" tabindex="-1"></a>    x0 <span class="op">=</span> <span class="va">self</span>.center <span class="op">-</span> <span class="va">self</span>.extent <span class="op">/</span> <span class="dv">2</span></span>
<span id="bounding-box-methods-4"><a href="#bounding-box-methods-4" tabindex="-1"></a>    x1 <span class="op">=</span> <span class="va">self</span>.center <span class="op">+</span> <span class="va">self</span>.extent <span class="op">/</span> <span class="dv">2</span></span>
<span id="bounding-box-methods-5"><a href="#bounding-box-methods-5" tabindex="-1"></a>    g <span class="op">=</span> np.mgrid[x0.imag:x1.imag:<span class="va">self</span>.height<span class="op">*</span><span class="ot">1j</span>,</span>
<span id="bounding-box-methods-6"><a href="#bounding-box-methods-6" tabindex="-1"></a>                 x0.real:x1.real:<span class="va">self</span>.width<span class="op">*</span><span class="ot">1j</span>]</span>
<span id="bounding-box-methods-7"><a href="#bounding-box-methods-7" tabindex="-1"></a>    <span class="cf">return</span> g[<span class="dv">1</span>] <span class="op">+</span> g[<span class="dv">0</span>]<span class="op">*</span><span class="ot">1j</span></span>
<span id="bounding-box-methods-8"><a href="#bounding-box-methods-8" tabindex="-1"></a></span>
<span id="bounding-box-methods-9"><a href="#bounding-box-methods-9" tabindex="-1"></a><span class="kw">def</span> da_grid(<span class="va">self</span>):</span>
<span id="bounding-box-methods-10"><a href="#bounding-box-methods-10" tabindex="-1"></a>    <span class="co">"""Return the complex values on the grid in a 2d array."""</span></span>
<span id="bounding-box-methods-11"><a href="#bounding-box-methods-11" tabindex="-1"></a>    x0 <span class="op">=</span> <span class="va">self</span>.center <span class="op">-</span> <span class="va">self</span>.extent <span class="op">/</span> <span class="dv">2</span></span>
<span id="bounding-box-methods-12"><a href="#bounding-box-methods-12" tabindex="-1"></a>    x1 <span class="op">=</span> <span class="va">self</span>.center <span class="op">+</span> <span class="va">self</span>.extent <span class="op">/</span> <span class="dv">2</span></span>
<span id="bounding-box-methods-13"><a href="#bounding-box-methods-13" tabindex="-1"></a>    x <span class="op">=</span> np.linspace(x0.real, x1.real, <span class="va">self</span>.width, endpoint<span class="op">=</span><span class="va">False</span>)</span>
<span id="bounding-box-methods-14"><a href="#bounding-box-methods-14" tabindex="-1"></a>    y <span class="op">=</span> np.linspace(x0.imag, x1.imag, <span class="va">self</span>.height, endpoint<span class="op">=</span><span class="va">False</span>)</span>
<span id="bounding-box-methods-15"><a href="#bounding-box-methods-15" tabindex="-1"></a>    g <span class="op">=</span> da.meshgrid(x, y)</span>
<span id="bounding-box-methods-16"><a href="#bounding-box-methods-16" tabindex="-1"></a>    <span class="cf">return</span> g[<span class="dv">1</span>] <span class="op">+</span> g[<span class="dv">0</span>]<span class="op">*</span><span class="ot">1j</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb11" file="src/mandelbrot/vectorized.py">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="im">from</span> numba <span class="im">import</span> guvectorize, int64, complex128  <span class="co"># type:ignore</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="im">from</span> .bounding_box <span class="im">import</span> BoundingBox</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="at">@guvectorize</span>([(complex128[:, :], int64, int64[:, :])],</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>             <span class="st">"(n,m),()-&gt;(n,m)"</span>,</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>             nopython<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="kw">def</span> compute_mandelbrot_numba(inp, max_iter: <span class="bu">int</span>, result):</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(inp.shape[<span class="dv">0</span>]):</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(inp.shape[<span class="dv">1</span>]):</span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>            c <span class="op">=</span> inp[j, i]</span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>            z <span class="op">=</span> <span class="fl">0.0</span><span class="op">+</span><span class="ot">0.0j</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>            <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(max_iter):</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>                z <span class="op">=</span> z<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> c</span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>                <span class="cf">if</span> (z<span class="op">*</span>z.conjugate()).real <span class="op">&gt;=</span> <span class="fl">4.0</span>:</span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>            result[j, i] <span class="op">=</span> k</span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a><span class="kw">def</span> compute_mandelbrot(box: BoundingBox, max_iter: <span class="bu">int</span>, throttle: Any <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>    result <span class="op">=</span> np.zeros((box.height, box.width), np.int64)</span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a>    c <span class="op">=</span> box.grid()</span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a>    compute_mandelbrot_numba(c, max_iter, result)</span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a>    <span class="cf">return</span> result</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="accordionSolution7" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution7" aria-expanded="false" aria-controls="collapseSolution7">
  <h4 class="accordion-header" id="headingSolution7">
  Benchmarks
  </h4>
</button>
<div id="collapseSolution7" class="accordion-collapse collapse" data-bs-parent="#accordionSolution7" aria-labelledby="headingSolution7">
<div class="accordion-body">
<figure><img src="../fig/mandelbrot-timings.svg" alt="performance curves" class="figure mx-auto d-block"><div class="figcaption">Benchmarks</div>
</figure><div class="codewrapper sourceCode" id="cb12" file="src/mandelbrot/bench_all.py">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="im">import</span> timeit</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="im">from</span> . <span class="im">import</span> numba_serial, numba_parallel, vectorized, domain_splitting</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="im">from</span> .bounding_box <span class="im">import</span> BoundingBox, test_case</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>compile_box <span class="op">=</span> BoundingBox(<span class="dv">16</span>, <span class="dv">16</span>, <span class="fl">0.0</span><span class="op">+</span><span class="ot">0.0j</span>, <span class="fl">1.0</span><span class="op">+</span><span class="ot">1.0j</span>)</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>timing_box <span class="op">=</span> test_case</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a><span class="kw">def</span> compile_run(m):</span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>    m.compute_mandelbrot(compile_box, <span class="dv">1</span>)</span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a><span class="kw">def</span> timing_run(m, throttle: Optional[<span class="bu">int</span>] <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a>    m.compute_mandelbrot(timing_box, <span class="dv">1024</span>, throttle<span class="op">=</span>throttle)</span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a>modules <span class="op">=</span> [<span class="st">"numba_serial:1"</span>, <span class="st">"vectorized:1"</span>] <span class="op">\</span></span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a>        <span class="op">+</span> [<span class="ss">f"domain_splitting:</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">9</span>)] <span class="op">\</span></span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a>        <span class="op">+</span> [<span class="ss">f"numba_parallel:</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">9</span>)]</span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb12-25"><a href="#cb12-25" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"timings.txt"</span>, <span class="st">"w"</span>) <span class="im">as</span> out:</span>
<span id="cb12-26"><a href="#cb12-26" tabindex="-1"></a>        headings <span class="op">=</span> [<span class="st">"name"</span>, <span class="st">"n"</span>, <span class="st">"min"</span>, <span class="st">"mean"</span>, <span class="st">"max"</span>]</span>
<span id="cb12-27"><a href="#cb12-27" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>headings[<span class="dv">0</span>]<span class="sc">:&lt;20}</span><span class="ss">"</span> \</span>
<span id="cb12-28"><a href="#cb12-28" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>headings[<span class="dv">1</span>]<span class="sc">:&gt;10}</span><span class="ss">"</span> \</span>
<span id="cb12-29"><a href="#cb12-29" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>headings[<span class="dv">2</span>]<span class="sc">:&gt;10}</span><span class="ss">"</span> \</span>
<span id="cb12-30"><a href="#cb12-30" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>headings[<span class="dv">3</span>]<span class="sc">:&gt;10}</span><span class="ss">"</span> \</span>
<span id="cb12-31"><a href="#cb12-31" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>headings[<span class="dv">4</span>]<span class="sc">:&gt;10}</span><span class="ss">"</span>,</span>
<span id="cb12-32"><a href="#cb12-32" tabindex="-1"></a>              <span class="bu">file</span><span class="op">=</span>out)</span>
<span id="cb12-33"><a href="#cb12-33" tabindex="-1"></a>        <span class="cf">for</span> mn <span class="kw">in</span> modules:</span>
<span id="cb12-34"><a href="#cb12-34" tabindex="-1"></a>            m, n <span class="op">=</span> mn.split(<span class="st">":"</span>)</span>
<span id="cb12-35"><a href="#cb12-35" tabindex="-1"></a>            n_cpus <span class="op">=</span> <span class="bu">int</span>(n)</span>
<span id="cb12-36"><a href="#cb12-36" tabindex="-1"></a>            setup <span class="op">=</span> <span class="ss">f"from mandelbrot.bench_all import timing_run, compile_run</span><span class="ch">\n</span><span class="ss">"</span> \</span>
<span id="cb12-37"><a href="#cb12-37" tabindex="-1"></a>                    <span class="ss">f"from mandelbrot import </span><span class="sc">{</span>m<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span> \</span>
<span id="cb12-38"><a href="#cb12-38" tabindex="-1"></a>                    <span class="ss">f"compile_run(</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb12-39"><a href="#cb12-39" tabindex="-1"></a>            times <span class="op">=</span> timeit.repeat(</span>
<span id="cb12-40"><a href="#cb12-40" tabindex="-1"></a>                stmt<span class="op">=</span><span class="ss">f"timing_run(</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>n_cpus<span class="sc">}</span><span class="ss">)"</span>,</span>
<span id="cb12-41"><a href="#cb12-41" tabindex="-1"></a>                setup<span class="op">=</span>setup,</span>
<span id="cb12-42"><a href="#cb12-42" tabindex="-1"></a>                number<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb12-43"><a href="#cb12-43" tabindex="-1"></a>                repeat<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb12-44"><a href="#cb12-44" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>m<span class="sc">:20}</span><span class="ss">"</span> \</span>
<span id="cb12-45"><a href="#cb12-45" tabindex="-1"></a>                  <span class="ss">f"</span><span class="sc">{</span>n_cpus<span class="sc">:&gt;10}</span><span class="ss">"</span> \</span>
<span id="cb12-46"><a href="#cb12-46" tabindex="-1"></a>                  <span class="ss">f"</span><span class="sc">{</span><span class="bu">min</span>(times)<span class="sc">:10.5g}</span><span class="ss">"</span> \</span>
<span id="cb12-47"><a href="#cb12-47" tabindex="-1"></a>                  <span class="ss">f"</span><span class="sc">{</span><span class="bu">sum</span>(times)<span class="op">/</span><span class="bu">len</span>(times)<span class="sc">:10.5g}</span><span class="ss">"</span> \</span>
<span id="cb12-48"><a href="#cb12-48" tabindex="-1"></a>                  <span class="ss">f"</span><span class="sc">{</span><span class="bu">max</span>(times)<span class="sc">:10.5g}</span><span class="ss">"</span>,</span>
<span id="cb12-49"><a href="#cb12-49" tabindex="-1"></a>                  <span class="bu">file</span><span class="op">=</span>out)</span>
<span id="cb12-50"><a href="#cb12-50" tabindex="-1"></a></span>
<span id="cb12-51"><a href="#cb12-51" tabindex="-1"></a>    <span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb12-52"><a href="#cb12-52" tabindex="-1"></a>    <span class="im">from</span> plotnine <span class="im">import</span> ggplot, geom_point, geom_ribbon, geom_line, aes</span>
<span id="cb12-53"><a href="#cb12-53" tabindex="-1"></a>    timings <span class="op">=</span> pd.read_table(<span class="st">"timings.txt"</span>, delimiter<span class="op">=</span><span class="st">" +"</span>, engine<span class="op">=</span><span class="st">"python"</span>)</span>
<span id="cb12-54"><a href="#cb12-54" tabindex="-1"></a>    plot <span class="op">=</span> ggplot(timings, aes(x<span class="op">=</span><span class="st">"n"</span>, y<span class="op">=</span><span class="st">"mean"</span>, ymin<span class="op">=</span><span class="st">"min"</span>, ymax<span class="op">=</span><span class="st">"max"</span>,</span>
<span id="cb12-55"><a href="#cb12-55" tabindex="-1"></a>                               color<span class="op">=</span><span class="st">"name"</span>, fill<span class="op">=</span><span class="st">"name"</span>)) <span class="op">\</span></span>
<span id="cb12-56"><a href="#cb12-56" tabindex="-1"></a>        <span class="op">+</span> geom_ribbon(alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span><span class="st">"none"</span>) <span class="op">\</span></span>
<span id="cb12-57"><a href="#cb12-57" tabindex="-1"></a>        <span class="op">+</span> geom_point() <span class="op">+</span> geom_line()</span>
<span id="cb12-58"><a href="#cb12-58" tabindex="-1"></a>    plot.save(<span class="st">"mandelbrot-timings.svg"</span>)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="extra-julia-sets">Extra: Julia sets<a class="anchor" aria-label="anchor" href="#extra-julia-sets"></a>
</h2>
<p>For each value <span class="math display">\[c\]</span> we can compute
the Julia set, namely the set of starting values <span class="math display">\[z_1\]</span> for which the iteration over <span class="math display">\[z_{n+1}=z_n^2 + c\]</span> converges. Every
location on the Mandelbrot image corresponds to its own unique Julia
set.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>max_iter <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>center <span class="op">=</span> <span class="fl">0.0</span><span class="op">+</span><span class="ot">0.0j</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>extent <span class="op">=</span> <span class="fl">4.0</span><span class="op">+</span><span class="ot">3.0j</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>scale <span class="op">=</span> <span class="bu">max</span>((extent <span class="op">/</span> width).real, (extent <span class="op">/</span> height).imag)</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>result <span class="op">=</span> np.zeros((height, width), <span class="bu">int</span>)</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>c <span class="op">=</span> <span class="op">-</span><span class="fl">1.1193</span><span class="op">+</span><span class="ot">0.2718j</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(height):</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(width):</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>        z <span class="op">=</span> center <span class="op">+</span> (i <span class="op">-</span> width <span class="op">//</span> <span class="dv">2</span> <span class="op">+</span> (j <span class="op">-</span> height <span class="op">//</span> <span class="dv">2</span>)<span class="op">*</span><span class="ot">1j</span>) <span class="op">*</span> scale</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(max_iter):</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>            z <span class="op">=</span> z<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> c</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>            <span class="cf">if</span> (z <span class="op">*</span> z.conjugate()).real <span class="op">&gt;</span> <span class="fl">4.0</span>:</span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>        result[j, i] <span class="op">=</span> k</span></code></pre>
</div>
<p>If we take the centre of the last image, we get the following
rendering of the Julia set:</p>
<figure><img src="../fig/julia-1.png" alt="colorful rendering of a Julia set" class="figure mx-auto d-block"><div class="figcaption">Example of a Julia set</div>
</figure><div id="generalize" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="generalize" class="callout-inner">
<h3 class="callout-title">Generalize</h3>
<div class="callout-content">
<p>Can you generalize your Mandelbrot code to compute both the
Mandelbrot and the Julia sets efficiently, while reusing as much code as
possible?</p>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Actually making code faster is not always straightforward.</li>
<li>Easy one-liners <em>can</em> get you 80% of the way.</li>
<li>Writing clean and modular code often makes parallelization easier
later on.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div>
</div></section><section id="aio-extra-asyncio"><p>Content from <a href="extra-asyncio.html">Asyncio</a></p>
<hr>
<p>Last updated on 2025-03-31 |

        <a href="https://example.com/template-source/edit/main/episodes/extra-asyncio.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 40 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What is Asyncio?</li>
<li>When is Asyncio useful?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Understand the difference between a function and a coroutine.</li>
<li>Know the rudimentary basics of <code>asyncio</code>.</li>
<li>Perform parallel computations in <code>asyncio</code>.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="introduction-to-asyncio">Introduction to Asyncio<a class="anchor" aria-label="anchor" href="#introduction-to-asyncio"></a>
</h1>
<p>Asyncio stands for “asynchronous IO” and, as you might have guessed,
has little to do with either asynchronous work or doing IO. In general,
the adjective asynchronous describes objects or events not coordinated
in time. In fact, the <code>asyncio</code> system is more like a set of
gears carefully tuned to run a multitude of tasks <em>as if</em> a lot
of OS threads were running. In the end, they are all powered by the same
crank. The gears in <code>asyncio</code> are called
<strong>coroutines</strong> and its teeth move other coroutines wherever
you find the <code>await</code> keyword.</p>
<p>The main application for <code>asyncio</code> is hosting back-ends
for web services, where a lot of tasks may be waiting for each other
while the server remains responsive to new events. In that regard,
<code>asyncio</code> is a little bit outside the domain of computational
science. Nevertheless, you may encounter Asyncio code in the wild, and
you <em>can</em> do parallelism with Asyncio if you want higher-level
abstraction without <code>dask</code> or similar alternatives.</p>
<p>Many modern programming languages do have features very similar to
<code>asyncio</code>.</p>
<div class="section level2">
<h2 id="run-time">Run-time<a class="anchor" aria-label="anchor" href="#run-time"></a>
</h2>
<p>The distinctive point of <code>asyncio</code> is a formalism for
carrying out work that is different from usual functions. We need to
look deeper into functions to appreciate the distinction.</p>
<div class="section level3">
<h3 id="call-stacks">Call stacks<a class="anchor" aria-label="anchor" href="#call-stacks"></a>
</h3>
<p>A function call is best understood in terms of a stack-based system.
When calling a function, you give it its arguments and temporarily
forget what you were doing. Or, rather, you push on a stack and forget
whatever you were doing. Then, you start working with the given
arguments on a clean sheet (called a stack frame) until you obtain the
function result. When you return to the stack, you remember only this
result and recall what you originally needed it for. In this manner,
every function call pushes a frame onto the stack and every return
statement has us popping back to the previous frame.</p>
<p><a href="https://mermaid.live/edit#pako:eNp1kL1Ow0AQhF9luSYgHApEdUUogpCoKRCSm8U3JpbtXXM_NlGUd-dMYgqkdKvb-Wb25mAqdTDWBHwlSIWnhj8996UQcRWbkSNoy10HPz-dpvVmc_ucJK9VLG01dY72mmjowAHEEiZ46mFp2nGkJlB9_X3zOBssWLZYn8wsvSMUFHd_YNY_3N9dinubLScOv8TgMTaawhm9GPFCTmUVqRWdCpqwGkGCMYeFQVsIfaBWj6uZF81f1nm30BCXk3TpxeFfM6YwPXzPjctFHmZJafJ1PUpj8-jYt6Up5Zh1nKK-7qUyNvqEwqTBZZ9z6cbW3AUcfwB5sYta" class="external-link"><img src="https://mermaid.ink/img/pako:eNp1kL1Ow0AQhF9luSYgHApEdUUogpCoKRCSm8U3JpbtXXM_NlGUd-dMYgqkdKvb-Wb25mAqdTDWBHwlSIWnhj8996UQcRWbkSNoy10HPz-dpvVmc_ucJK9VLG01dY72mmjowAHEEiZ46mFp2nGkJlB9_X3zOBssWLZYn8wsvSMUFHd_YNY_3N9dinubLScOv8TgMTaawhm9GPFCTmUVqRWdCpqwGkGCMYeFQVsIfaBWj6uZF81f1nm30BCXk3TpxeFfM6YwPXzPjctFHmZJafJ1PUpj8-jYt6Up5Zh1nKK-7qUyNvqEwqTBZZ9z6cbW3AUcfwB5sYta?type=png" class="figure"></a></p>
<details><summary>
Mermaid code for above diagram
</summary><pre class="mermaid"><code>sequenceDiagram
  Caller-&gt;&gt;+Function: Could you please answer me: what is f(x)?
  Function-&gt;&gt;-Caller: Yes, the answer is 42.
  Caller-&gt;&gt;+Function: What was the previous answer?
  Function-&gt;&gt;-Caller: I don't know, we've never spoken before!</code></pre>
</details><p>Crucially, when we pop back, we also forget the stack frame inside
the function. This way of doing always keeps a single conscious stream
of thought. Function calls can be evaluated by a single active
agent.</p>
</div>
<div class="section level3">
<h3 id="coroutines">Coroutines<a class="anchor" aria-label="anchor" href="#coroutines"></a>
</h3>
<div id="accordionInstructor1" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor1" aria-expanded="false" aria-controls="collapseInstructor1">
  <h3 class="accordion-header" id="headingInstructor1">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div> Instructor Note </h3>
</button>
<div id="collapseInstructor1" class="accordion-collapse collapse" aria-labelledby="headingInstructor1" data-bs-parent="#accordionInstructor1">
<div class="accordion-body">
<p>This section goes rather in depth into coroutines. This is meant to
nurture the correct mental model about what goes on with
<code>asyncio</code>.</p>
</div>
</div>
</div>
</div>
<p>Working with coroutines changes things a bit. The coroutine keeps on
existing and its context is not forgotten when a coroutine returns a
result. Python has several forms of coroutines and the simplest is a
<strong>generator</strong>. For example, the following generator
produces all integers (if you wait long enough):</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="kw">def</span> integers():</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>  a <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>  <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    <span class="cf">yield</span> a</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>    a <span class="op">+=</span> <span class="dv">1</span></span></code></pre>
</div>
<p>Then:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> integers():</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>  <span class="bu">print</span>(i)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>  <span class="cf">if</span> i <span class="op">&gt;</span> <span class="dv">10</span>:   <span class="co"># or this would take a while</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>    <span class="cf">break</span></span></code></pre>
</div>
<p>or:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> islice</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>islice(integers(), <span class="dv">0</span>, <span class="dv">10</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</code></pre>
</div>
<p><a href="https://mermaid.live/edit#pako:eNqtkT1Pw0AMhv-KuYWBdIDxhjAEqepUJAaWLG7OTU-9j-DzlUZV_zsXhQgqMbJZ9vPafu2L6qIhpVWij0yhoxeLPaNvAwB2Yk8oBA06Rzyl5mhV1w-bINQTJw2vjjARJEEW6GIOYkP_Cy70D_x-QAGbQA4Egc4CIfsd8fPEL9SkmLUaHv-r0dNUCLG4iSdiWNIUDAwcF8uG_jC9bm5Hb-49pMg8VjDGDJ_EBPvIfRShALiLWe5u1qjr1brRsD1WRetcOVUcgM42zZdSlfLEHq0pf7hMylYVW55apUtokI-tasO1cJglvo2hU1o4U6XyYMqu3z9Teo8u0fUL2jOgcw" class="external-link"><img src="https://mermaid.ink/img/pako:eNqtkT1Pw0AMhv-KuYWBdIDxhjAEqepUJAaWLG7OTU-9j-DzlUZV_zsXhQgqMbJZ9vPafu2L6qIhpVWij0yhoxeLPaNvAwB2Yk8oBA06Rzyl5mhV1w-bINQTJw2vjjARJEEW6GIOYkP_Cy70D_x-QAGbQA4Egc4CIfsd8fPEL9SkmLUaHv-r0dNUCLG4iSdiWNIUDAwcF8uG_jC9bm5Hb-49pMg8VjDGDJ_EBPvIfRShALiLWe5u1qjr1brRsD1WRetcOVUcgM42zZdSlfLEHq0pf7hMylYVW55apUtokI-tasO1cJglvo2hU1o4U6XyYMqu3z9Teo8u0fUL2jOgcw?type=png" class="figure"></a></p>
<details><summary>
Mermaid code for above diagram
</summary><pre class="mermaid"><code>sequenceDiagram
  Caller-&gt;&gt;+Integers: Please start counting
  Caller--&gt;&gt;Integers: What is the next number?
  Integers--&gt;&gt;Caller: 1
  Caller--&gt;&gt;Integers: What is the next number?
  Integers--&gt;&gt;Caller: 2
  GC--&gt;&gt;Integers: I'm sorry, you were forgotten about!
  Integers-&gt;&gt;-GC: Ok, I'll stop existing</code></pre>
</details><div id="challenge-generate-all-even-numbers" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-generate-all-even-numbers" class="callout-inner">
<h3 class="callout-title">Challenge: generate all even numbers</h3>
<div class="callout-content">
<p>Can you write a generator for all even numbers? Reuse
<code>integers()</code>. Extra: Can you generate the Fibonacci
sequence?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="kw">def</span> even_integers():</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> integers():</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    <span class="cf">if</span> i <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>      <span class="cf">yield</span> i</span></code></pre>
</div>
<p>or</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">def</span> even_integers():</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  <span class="cf">return</span> (i <span class="cf">for</span> i <span class="kw">in</span> integers() <span class="cf">if</span> i <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span>)</span></code></pre>
</div>
<p>For the Fibonacci series:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="kw">def</span> fib():</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>  a, b <span class="op">=</span> <span class="dv">1</span>, <span class="dv">1</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>  <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>    <span class="cf">yield</span> a</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>    a, b <span class="op">=</span> b, a <span class="op">+</span> b</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>The generator gives away control, passing back a value and expecting
to receive control one more time, if faith has it. All meanings of the
keyword <code>yield</code> apply here: the coroutine yields control and
produces a yield, as if we were harvesting a crop.</p>
<p>Conceptually, a generator entails one-way traffic only: we get
output. However, we can use <code>yield</code> also to send information
to a coroutine. For example, this coroutine prints whatever you send to
it:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="kw">def</span> printer():</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>  <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>    x <span class="op">=</span> <span class="cf">yield</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>    <span class="bu">print</span>(x)</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>p <span class="op">=</span> printer()</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="bu">next</span>(p)   <span class="co"># we need to advance the coroutine to the first yield</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>p.send(<span class="st">"Mercury"</span>)</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>p.send(<span class="st">"Venus"</span>)</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>p.send(<span class="st">"Earth"</span>)</span></code></pre>
</div>
<div id="challenge-line-numbers" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-line-numbers" class="callout-inner">
<h3 class="callout-title">Challenge: line numbers</h3>
<div class="callout-content">
<p>Change <code>printer</code> to add line numbers to the output.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="kw">def</span> printer():</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>  lineno <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>    x <span class="op">=</span> <span class="cf">yield</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>lineno<span class="sc">:03}</span><span class="ss"> </span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>    lineno <span class="op">+=</span> <span class="dv">1</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>In practice, the send-form of coroutines is hardly ever used. Cases
for needing it are infrequent, and chances are that nobody will
understand your code. Asyncio has largely superseded this usage.</p>
<p>The working of <code>asyncio</code> is only a small step farther than
that of coroutines. The intuition is to use coroutines to build a
collaborative multi-threading environment. Most modern operating systems
assign some time to execution threads and take back control
pre-emptively to do something else. In <strong>collaborative
multi-tasking</strong>, every worker knows to be part of a collaborative
environment and yields control to the scheduler voluntarily. Creating
such a system with coroutines and <code>yield</code> is possible in
principle, but is not straightforward especially owing to the
propagation of exceptions.</p>
</div>
</div>
<div class="section level2">
<h2 id="syntax">Syntax<a class="anchor" aria-label="anchor" href="#syntax"></a>
</h2>
<p><code>asyncio</code> itself is a library in standard Python and is a
core component for actually using the associated async syntax. Two
keywords are especially relevant here: <code>async</code> and
<code>await</code>.</p>
<p><code>async</code> is a modifier keyword that makes any subsequent
syntax behave consistently with the asynchronous run-time.</p>
<p><code>await</code> is used inside a coroutine to wait until another
coroutine yields a result. Effectively, the scheduler takes control
again and may decide to return it when a result is present.</p>
</div>
</div>
<div class="section level1">
<h1 id="a-first-program">A first program<a class="anchor" aria-label="anchor" href="#a-first-program"></a>
</h1>
<p>Jupyter understands asynchronous code, so you can <code>await</code>
futures in any cell:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> counter(name):</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span>i<span class="sc">:03}</span><span class="ss">"</span>)</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>    <span class="cf">await</span> asyncio.sleep(<span class="fl">0.2</span>)</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a><span class="cf">await</span> counter(<span class="st">"Venus"</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Venus      000
Venus      001
Venus      002
Venus      003
Venus      004</code></pre>
</div>
<p>We can have coroutines work concurrently when we <code>gather</code>
them:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="cf">await</span> asyncio.gather(counter(<span class="st">"Earth"</span>), counter(<span class="st">"Moon"</span>))</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Earth      000
Moon       000
Earth      001
Moon       001
Earth      002
Moon       002
Earth      003
Moon       003
Earth      004
Moon       004
```§


Note that, although the Earth counter and Moon counter seem to operate at the same time, the scheduler is actually alternating them in a single thread! If you work outside of Jupyter, you need an asynchronous main function and must run it using `asyncio.run`. A typical program will look like this:

```python
import asyncio

...

async def main():
    ...

if __name__ == "__main__":
    asyncio.run(main())</code></pre>
</div>
<p>Asyncio is as contagious as Dask. Any higher-level code must be async
once you have some async low-level code: <a href="https://en.wikipedia.org/wiki/Turtles_all_the_way_down" class="external-link">it’s
turtles all the way down</a>! You may be tempted to implement
<code>asyncio.run</code> in the middle of your code and interact with
the asynchronous parts. Multiple active Asyncio run-times will get you
into troubles, though. Mixing Asyncio and classic code is possible in
principle, but is considered bad practice.</p>
<div class="section level2">
<h2 id="timing-asynchronous-code">Timing asynchronous code<a class="anchor" aria-label="anchor" href="#timing-asynchronous-code"></a>
</h2>
<p>Jupyter works very well with <code>asyncio</code> except for line
magics and cell magics. We must then write our own timer.</p>
<div id="accordionInstructor2" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor2" aria-expanded="false" aria-controls="collapseInstructor2">
  <h3 class="accordion-header" id="headingInstructor2">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div> Instructor Note </h3>
</button>
<div id="collapseInstructor2" class="accordion-collapse collapse" aria-labelledby="headingInstructor2" data-bs-parent="#accordionInstructor2">
<div class="accordion-body">
<p>It may be best to have participants copy and paste this snippet from
the collaborative document. You may want to explain what a context
manager is, but don’t overdo it. This is advanced code and may scare off
novices.</p>
</div>
</div>
</div>
</div>
<div class="codewrapper sourceCode" id="async-timer">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="async-timer-1"><a href="#async-timer-1" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="async-timer-2"><a href="#async-timer-2" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional</span>
<span id="async-timer-3"><a href="#async-timer-3" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> perf_counter</span>
<span id="async-timer-4"><a href="#async-timer-4" tabindex="-1"></a><span class="im">from</span> contextlib <span class="im">import</span> asynccontextmanager</span>
<span id="async-timer-5"><a href="#async-timer-5" tabindex="-1"></a></span>
<span id="async-timer-6"><a href="#async-timer-6" tabindex="-1"></a></span>
<span id="async-timer-7"><a href="#async-timer-7" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="async-timer-8"><a href="#async-timer-8" tabindex="-1"></a><span class="kw">class</span> Elapsed:</span>
<span id="async-timer-9"><a href="#async-timer-9" tabindex="-1"></a>    time: Optional[<span class="bu">float</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="async-timer-10"><a href="#async-timer-10" tabindex="-1"></a></span>
<span id="async-timer-11"><a href="#async-timer-11" tabindex="-1"></a></span>
<span id="async-timer-12"><a href="#async-timer-12" tabindex="-1"></a><span class="at">@asynccontextmanager</span></span>
<span id="async-timer-13"><a href="#async-timer-13" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> timer():</span>
<span id="async-timer-14"><a href="#async-timer-14" tabindex="-1"></a>    e <span class="op">=</span> Elapsed()</span>
<span id="async-timer-15"><a href="#async-timer-15" tabindex="-1"></a>    t <span class="op">=</span> perf_counter()</span>
<span id="async-timer-16"><a href="#async-timer-16" tabindex="-1"></a>    <span class="cf">yield</span> e</span>
<span id="async-timer-17"><a href="#async-timer-17" tabindex="-1"></a>    e.time <span class="op">=</span> perf_counter() <span class="op">-</span> t</span></code></pre>
</div>
<p>Now we can write:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="cf">async</span> <span class="cf">with</span> timer() <span class="im">as</span> t:</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>  <span class="cf">await</span> asyncio.sleep(<span class="fl">0.2</span>)</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"that took </span><span class="sc">{</span>t<span class="sc">.</span>time<span class="sc">}</span><span class="ss"> seconds"</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>that took 0.20058414503000677 seconds</code></pre>
</div>
<p>Understanding these few snippets of code requires advanced knowledge
of Python. Rest assured that both classic coroutines and
<code>asyncio</code> are complex topics that we cannot cover completely.
However, we can time the execution of our code now!</p>
</div>
<div class="section level2">
<h2 id="compute-pi-again">Compute <span class="math inline">\(\pi\)</span> again<a class="anchor" aria-label="anchor" href="#compute-pi-again"></a>
</h2>
<p>As a reminder, here is our Numba code for computing <span class="math inline">\(\pi\)</span>:</p>
<div class="codewrapper sourceCode" id="calc-pi-numba">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="calc-pi-numba-1"><a href="#calc-pi-numba-1" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="calc-pi-numba-2"><a href="#calc-pi-numba-2" tabindex="-1"></a><span class="im">import</span> numba</span>
<span id="calc-pi-numba-3"><a href="#calc-pi-numba-3" tabindex="-1"></a></span>
<span id="calc-pi-numba-4"><a href="#calc-pi-numba-4" tabindex="-1"></a></span>
<span id="calc-pi-numba-5"><a href="#calc-pi-numba-5" tabindex="-1"></a><span class="at">@numba.njit</span>(nogil<span class="op">=</span><span class="va">True</span>)</span>
<span id="calc-pi-numba-6"><a href="#calc-pi-numba-6" tabindex="-1"></a><span class="kw">def</span> calc_pi(N):</span>
<span id="calc-pi-numba-7"><a href="#calc-pi-numba-7" tabindex="-1"></a>    M <span class="op">=</span> <span class="dv">0</span></span>
<span id="calc-pi-numba-8"><a href="#calc-pi-numba-8" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="calc-pi-numba-9"><a href="#calc-pi-numba-9" tabindex="-1"></a>        <span class="co"># Simulate impact coordinates</span></span>
<span id="calc-pi-numba-10"><a href="#calc-pi-numba-10" tabindex="-1"></a>        x <span class="op">=</span> random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="calc-pi-numba-11"><a href="#calc-pi-numba-11" tabindex="-1"></a>        y <span class="op">=</span> random.uniform(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="calc-pi-numba-12"><a href="#calc-pi-numba-12" tabindex="-1"></a></span>
<span id="calc-pi-numba-13"><a href="#calc-pi-numba-13" tabindex="-1"></a>        <span class="co"># True if impact happens inside the circle</span></span>
<span id="calc-pi-numba-14"><a href="#calc-pi-numba-14" tabindex="-1"></a>        <span class="cf">if</span> x<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> y<span class="op">**</span><span class="dv">2</span> <span class="op">&lt;</span> <span class="fl">1.0</span>:</span>
<span id="calc-pi-numba-15"><a href="#calc-pi-numba-15" tabindex="-1"></a>            M <span class="op">+=</span> <span class="dv">1</span></span>
<span id="calc-pi-numba-16"><a href="#calc-pi-numba-16" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">4</span> <span class="op">*</span> M <span class="op">/</span> N</span></code></pre>
</div>
<p>We can send this work to another thread with
<code>asyncio.to_thread</code>:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="cf">async</span> <span class="cf">with</span> timer() <span class="im">as</span> t:</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>    <span class="cf">await</span> asyncio.to_thread(calc_pi, <span class="dv">10</span><span class="op">**</span><span class="dv">7</span>)</span></code></pre>
</div>
<div id="gather-multiple-outcomes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="gather-multiple-outcomes" class="callout-inner">
<h3 class="callout-title">Gather multiple outcomes</h3>
<div class="callout-content">
<p>We have already seen that <code>asyncio.gather</code> gathers
multiple coroutines. Here, gather several <code>calc_pi</code>
computations and time them.</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="cf">async</span> <span class="cf">with</span> timer() <span class="im">as</span> t:</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>    result <span class="op">=</span> <span class="cf">await</span> asyncio.gather(</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>       asyncio.to_thread(calc_pi, <span class="dv">10</span><span class="op">**</span><span class="dv">7</span>),</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>       asyncio.to_thread(calc_pi, <span class="dv">10</span><span class="op">**</span><span class="dv">7</span>))</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>We can put this into a new function <code>calc_pi_split</code>:</p>
<div class="codewrapper sourceCode" id="async-calc-pi">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="async-calc-pi-1"><a href="#async-calc-pi-1" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> calc_pi_split(N, M):</span>
<span id="async-calc-pi-2"><a href="#async-calc-pi-2" tabindex="-1"></a>    lst <span class="op">=</span> <span class="cf">await</span> asyncio.gather(<span class="op">*</span>(asyncio.to_thread(calc_pi, N) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(M)))</span>
<span id="async-calc-pi-3"><a href="#async-calc-pi-3" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sum</span>(lst) <span class="op">/</span> M</span></code></pre>
</div>
<p>and then verify the speed-up that we get:</p>
<div class="codewrapper sourceCode" id="async-calc-pi-main">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="async-calc-pi-main-1"><a href="#async-calc-pi-main-1" tabindex="-1"></a><span class="cf">async</span> <span class="cf">with</span> timer() <span class="im">as</span> t:</span>
<span id="async-calc-pi-main-2"><a href="#async-calc-pi-main-2" tabindex="-1"></a>    pi <span class="op">=</span> <span class="cf">await</span> asyncio.to_thread(calc_pi, <span class="dv">10</span><span class="op">**</span><span class="dv">8</span>)</span>
<span id="async-calc-pi-main-3"><a href="#async-calc-pi-main-3" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Value of π: </span><span class="sc">{</span>pi<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="async-calc-pi-main-4"><a href="#async-calc-pi-main-4" tabindex="-1"></a></span>
<span id="async-calc-pi-main-5"><a href="#async-calc-pi-main-5" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"that took </span><span class="sc">{</span>t<span class="sc">.</span>time<span class="sc">}</span><span class="ss"> seconds"</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Value of π: 3.1418552
that took 2.3300534340087324 seconds</code></pre>
</div>
<div class="codewrapper sourceCode" id="async-calc-pi-main">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="async-calc-pi-main-1"><a href="#async-calc-pi-main-1" tabindex="-1"></a><span class="cf">async</span> <span class="cf">with</span> timer() <span class="im">as</span> t:</span>
<span id="async-calc-pi-main-2"><a href="#async-calc-pi-main-2" tabindex="-1"></a>    pi <span class="op">=</span> <span class="cf">await</span> calc_pi_split(<span class="dv">10</span><span class="op">**</span><span class="dv">7</span>, <span class="dv">10</span>)</span>
<span id="async-calc-pi-main-3"><a href="#async-calc-pi-main-3" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Value of π: </span><span class="sc">{</span>pi<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="async-calc-pi-main-4"><a href="#async-calc-pi-main-4" tabindex="-1"></a></span>
<span id="async-calc-pi-main-5"><a href="#async-calc-pi-main-5" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"that took </span><span class="sc">{</span>t<span class="sc">.</span>time<span class="sc">}</span><span class="ss"> seconds"</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Value of π: 3.1416366400000006
that took 0.5876454019453377 seconds</code></pre>
</div>
</div>
</div>
<div class="section level1">
<h1 id="working-with-asyncio-outside-jupyter">Working with <code>asyncio</code> outside Jupyter<a class="anchor" aria-label="anchor" href="#working-with-asyncio-outside-jupyter"></a>
</h1>
<p>Jupyter already has an asynchronous loop running for us. In order to
run scripts outside Jupyter you should write an asynchronous main
function and call it using <code>asyncio.run</code>.</p>
<div id="compute-pi-in-a-script" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="compute-pi-in-a-script" class="callout-inner">
<h3 class="callout-title">Compute <span class="math inline">\(\pi\)</span> in a script</h3>
<div class="callout-content">
<p>Collect in a script what we have done so far to compute <span class="math inline">\(\pi\)</span> in parallel, and run it.</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4"> Show me the solution </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" aria-labelledby="headingSolution4" data-bs-parent="#accordionSolution4">
<div class="accordion-body">
<p>Ensure that you create an <code>async</code> main function, and run
it using <code>asyncio.run</code>. Create a small module called
<code>calc_pi</code>.</p>
<div class="codewrapper sourceCode" id="cb22" file="src/calc_pi/__init__.py">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="co"># file: calc_pi/__init__.py</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="co"># may remain empty</span></span></code></pre>
</div>
<p>Put the Numba code in a separate file
<code>calc_pi/numba.py</code>.</p>
<div class="codewrapper sourceCode" id="cb23" file="src/calc_pi/numba.py">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co"># file: calc_pi/numba.py</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="op">&lt;&lt;</span>calc<span class="op">-</span>pi<span class="op">-</span>numba<span class="op">&gt;&gt;</span></span></code></pre>
</div>
<p>Put the <code>async_timer</code> function in a separate file
<code>async_timer.py</code>.</p>
<div class="codewrapper sourceCode" id="cb24" file="src/async_timer.py">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="co"># file: async_timer.py</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a><span class="op">&lt;&lt;</span><span class="cf">async</span><span class="op">-</span>timer<span class="op">&gt;&gt;</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb25" file="src/calc_pi/async_pi.py">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co"># file: calc_pi/async_pi.py</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="im">from</span> async_timer <span class="im">import</span> timer</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a><span class="im">from</span> .numba <span class="im">import</span> calc_pi</span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a><span class="op">&lt;&lt;</span><span class="cf">async</span><span class="op">-</span>calc<span class="op">-</span>pi<span class="op">&gt;&gt;</span></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> main():</span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a>    calc_pi(<span class="dv">1</span>)</span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a>    <span class="op">&lt;&lt;</span><span class="cf">async</span><span class="op">-</span>calc<span class="op">-</span>pi<span class="op">-</span>main<span class="op">&gt;&gt;</span></span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a>    asyncio.run(main())</span></code></pre>
</div>
<p>You may run this script using
<code>python -m calc_pi.async_pi</code>.</p>
</div>
</div>
</div>
</div>
<div id="efficiency" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="efficiency" class="callout-inner">
<h3 class="callout-title">Efficiency</h3>
<div class="callout-content">
<p>Play with different subdivisions in <code>calc_pi_split</code>
keeping <code>M*N</code> constant. How much overhead do you see?</p>
</div>
</div>
</div>
<div id="accordionSolution5" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution5" aria-expanded="false" aria-controls="collapseSolution5">
  <h4 class="accordion-header" id="headingSolution5"> Show me the solution </h4>
</button>
<div id="collapseSolution5" class="accordion-collapse collapse" aria-labelledby="headingSolution5" data-bs-parent="#accordionSolution5">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb26" file="src/calc_pi/granularity.py">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> ggplot, geom_line, geom_point, aes, scale_y_log10, scale_x_log10</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a><span class="im">from</span> .numba <span class="im">import</span> calc_pi</span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a><span class="im">from</span> .async_pi <span class="im">import</span> calc_pi_split</span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a><span class="im">from</span> async_timer <span class="im">import</span> timer</span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a>calc_pi(<span class="dv">1</span>)  <span class="co"># compile the numba function</span></span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> main():</span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a>    timings <span class="op">=</span> []</span>
<span id="cb26-14"><a href="#cb26-14" tabindex="-1"></a>    <span class="cf">for</span> njobs <span class="kw">in</span> [<span class="dv">2</span><span class="op">**</span>i <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">13</span>)]:</span>
<span id="cb26-15"><a href="#cb26-15" tabindex="-1"></a>        jobsize <span class="op">=</span> <span class="dv">2</span><span class="op">**</span><span class="dv">25</span> <span class="op">//</span> njobs</span>
<span id="cb26-16"><a href="#cb26-16" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>jobsize<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span>njobs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-17"><a href="#cb26-17" tabindex="-1"></a>        <span class="cf">async</span> <span class="cf">with</span> timer() <span class="im">as</span> t:</span>
<span id="cb26-18"><a href="#cb26-18" tabindex="-1"></a>            <span class="cf">await</span> calc_pi_split(jobsize, njobs)</span>
<span id="cb26-19"><a href="#cb26-19" tabindex="-1"></a>        timings.append((jobsize, njobs, t.time))</span>
<span id="cb26-20"><a href="#cb26-20" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" tabindex="-1"></a>    timings <span class="op">=</span> pd.DataFrame(timings, columns<span class="op">=</span>(<span class="st">"jobsize"</span>, <span class="st">"njobs"</span>, <span class="st">"time"</span>))</span>
<span id="cb26-22"><a href="#cb26-22" tabindex="-1"></a>    plot <span class="op">=</span> ggplot(timings, aes(x<span class="op">=</span><span class="st">"njobs"</span>, y<span class="op">=</span><span class="st">"time"</span>)) <span class="op">\</span></span>
<span id="cb26-23"><a href="#cb26-23" tabindex="-1"></a>        <span class="op">+</span> geom_line() <span class="op">+</span> geom_point() <span class="op">+</span> scale_y_log10() <span class="op">+</span> scale_x_log10()</span>
<span id="cb26-24"><a href="#cb26-24" tabindex="-1"></a>    plot.save(<span class="st">"asyncio-timings.svg"</span>)</span>
<span id="cb26-25"><a href="#cb26-25" tabindex="-1"></a></span>
<span id="cb26-26"><a href="#cb26-26" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb26-27"><a href="#cb26-27" tabindex="-1"></a>    asyncio.run(main())</span></code></pre>
</div>
<figure><img src="../fig/asyncio-timings.svg" alt="a dip at njobs=10 and overhead ~0.1ms per task" class="figure mx-auto d-block"><div class="figcaption">timings</div>
</figure><p>The work takes about 0.1 s more when using 1000 tasks. So, assuming
that the total overhead is distributed uniformly among the tasks, we
observe that the overhead is around 0.1 ms per task.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Use the <code>async</code> keyword to write asynchronous code.</li>
<li>Use <code>await</code> to call coroutines.</li>
<li>Use <code>asyncio.gather</code> to collect work.</li>
<li>Use <code>asyncio.to_thread</code> to perform CPU intensive
tasks.</li>
<li>Inside a script: always create an asynchronous <code>main</code>
function, and run it with <code>asyncio.run</code>.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div></section><section id="aio-extra-external-c"><p>Content from <a href="extra-external-c.html">Calling External C and C++ Libraries from Python</a></p>
<hr>
<p>Last updated on 2025-03-31 |

        <a href="https://example.com/template-source/edit/main/episodes/extra-external-c.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 90 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>Which options are available to call from Python C and C++
libraries?</li>
<li>How does this work together with Numpy arrays?</li>
<li>How do I use this in multiple threads while lifting the GIL?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Compile and link simple C programs into shared libraries.</li>
<li>Call these libraries from Python and time their executions.</li>
<li>Compare the performance with Numba-decorated Python code.</li>
<li>Bypass the GIL when calling these libraries from multiple threads
simultaneously.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="calling-c-and-c-libraries">Calling C and C++ libraries<a class="anchor" aria-label="anchor" href="#calling-c-and-c-libraries"></a>
</h1>
<div class="section level2">
<h2 id="simple-example-using-either-pybind11-or-ctypes">Simple example using either pybind11 or ctypes<a class="anchor" aria-label="anchor" href="#simple-example-using-either-pybind11-or-ctypes"></a>
</h2>
<p>External C and C++ libraries can be called from Python code using a
number of options, e.g., Cython, CFFI, pybind11 and ctypes. We will
discuss the last two because simple cases require the least amount of
boilerplate. This may not be the case with more complex examples.
Consider this simple C program, <code>test.c</code>, which adds up
consecutive numbers:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">C<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode c" tabindex="0"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;pybind11/pybind11.h&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>namespace py <span class="op">=</span> pybind11<span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="dt">long</span> <span class="dt">long</span> sum_range<span class="op">(</span><span class="dt">long</span> <span class="dt">long</span> high<span class="op">)</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>  <span class="dt">long</span> <span class="dt">long</span> i<span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>  <span class="dt">long</span> <span class="dt">long</span> s <span class="op">=</span> <span class="dv">0</span><span class="bu">LL</span><span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="bu">LL</span><span class="op">;</span> i <span class="op">&lt;</span> high<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>      s <span class="op">+=</span> <span class="op">(</span><span class="dt">long</span> <span class="dt">long</span><span class="op">)</span>i<span class="op">;</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>  <span class="cf">return</span> s<span class="op">;</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>PYBIND11_MODULE<span class="op">(</span>test_pybind<span class="op">,</span> m<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>    m<span class="op">.</span>doc<span class="op">()</span> <span class="op">=</span> <span class="st">"Export the sum_range function as sum_range"</span><span class="op">;</span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>    m<span class="op">.</span>def<span class="op">(</span><span class="st">"sum_range"</span><span class="op">,</span> <span class="op">&amp;</span>sum_range<span class="op">,</span> <span class="st">"Adds upp consecutive integer numbers from 0 up to and including high-1"</span><span class="op">);</span></span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a><span class="op">}</span></span></code></pre>
</div>
<p>You can easily compile and link it into a shared object
(<code>*.so</code>) file with <code>pybind11</code>. You can install
that in several ways, like <code>pip</code>; I prefer creating virtual
environments using <code>pipenv</code>:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="ex">pip</span> install pipenv</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="ex">pipenv</span> install pybind11</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="ex">pipenv</span> shell</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="ex">c++</span> <span class="at">-O3</span> <span class="at">-Wall</span> <span class="at">-shared</span> <span class="at">-std</span><span class="op">=</span>c++11 <span class="at">-fPIC</span> <span class="kw">`</span><span class="ex">python3</span> <span class="at">-m</span> pybind11 <span class="at">--includes</span><span class="kw">`</span> test.c <span class="at">-o</span> test_pybind.so</span></code></pre>
</div>
<p>which generates a shared object <code>test_pybind.so</code>, which
can be called from a iPython shell as follows:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="op">%</span><span class="im">import</span> test_pybind</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="op">%</span>sum_range<span class="op">=</span>test_pybind.sum_range</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="op">%</span>high<span class="op">=</span><span class="dv">1000000000</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="op">%</span>brute_force_sum<span class="op">=</span>sum_range(high)</span></code></pre>
</div>
<p>Now you might want to check and compare the output with the
well-known formula for the sum of consecutive integers:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="op">%</span>sum_from_formula<span class="op">=</span>high<span class="op">*</span>(high<span class="op">-</span><span class="dv">1</span>)<span class="op">//</span><span class="dv">2</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="op">%</span>sum_from_formula</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="op">%</span>difference<span class="op">=</span>sum_from_formula<span class="op">-</span>brute_force_sum</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="op">%</span>difference</span></code></pre>
</div>
<p>Give this script a suitable name, such as
<code>call_C_libraries.py</code>. The same thing can be done using
<code>ctypes</code> instead of <code>pybind11</code>, but the coding
requires slightly more boilerplate on the Python side and slightly less
on the C side. The program <code>test.c</code> will just contain the
algorithm:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">C<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode c" tabindex="0"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="dt">long</span> <span class="dt">long</span> sum_range<span class="op">(</span><span class="dt">long</span> <span class="dt">long</span> high<span class="op">)</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  <span class="dt">long</span> <span class="dt">long</span> i<span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  <span class="dt">long</span> <span class="dt">long</span> s <span class="op">=</span> <span class="dv">0</span><span class="bu">LL</span><span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="bu">LL</span><span class="op">;</span> i <span class="op">&lt;</span> high<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>      s <span class="op">+=</span> <span class="op">(</span><span class="dt">long</span> <span class="dt">long</span><span class="op">)</span>i<span class="op">;</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>  <span class="cf">return</span> s<span class="op">;</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="op">}</span></span></code></pre>
</div>
<p>Compile and link with:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">gcc</span> <span class="at">-O3</span> <span class="at">-g</span> <span class="at">-fPIC</span> <span class="at">-c</span> <span class="at">-o</span> test.o test.c</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="fu">ld</span> <span class="at">-shared</span> <span class="at">-o</span> libtest.so test.o</span></code></pre>
</div>
<p>which generates a <code>libtest.so</code> file.</p>
<p>You then need some extra boilerplate:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="op">%</span><span class="im">import</span> ctypes</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="op">%</span>testlib <span class="op">=</span> ctypes.cdll.LoadLibrary(<span class="st">"./libtest.so"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="op">%</span>sum_range <span class="op">=</span> testlib.sum_range</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="op">%</span>sum_range.argtypes <span class="op">=</span> [ctypes.c_longlong]</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="op">%</span>sum_range.restype <span class="op">=</span> ctypes.c_longlong</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="op">%</span>high<span class="op">=</span><span class="dv">1000000000</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="op">%</span>brute_force_sum<span class="op">=</span>sum_range(high)</span></code></pre>
</div>
<p>Again, you can compare the result with the formula for the sum of
consecutive integers:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="op">%</span>sum_from_formula<span class="op">=</span>high<span class="op">*</span>(high<span class="op">-</span><span class="dv">1</span>)<span class="op">/</span><span class="dv">2</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="op">%</span>sum_from_formula</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="op">%</span>difference<span class="op">=</span>sum_from_formula<span class="op">-</span>brute_force_sum</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="op">%</span>difference</span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="performance">Performance<a class="anchor" aria-label="anchor" href="#performance"></a>
</h2>
<p>Now we can time our compiled <code>sum_range</code> C library,
e.g. from the iPython interface:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="op">%</span>timeit sum_range(<span class="dv">10</span><span class="op">**</span><span class="dv">7</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>2.69 ms ± 6.01 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)</code></pre>
</div>
<p>If you contrast with the Numba timing in <a href="computing-pi.html">Episode 3</a>, you will see that the C library
for <code>sum_range</code> is faster than the Numpy computation but
significantly slower than the <code>numba.jit</code>-decorated
function.</p>
<div id="c-versus-numba" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="c-versus-numba" class="callout-inner">
<h3 class="callout-title">C versus Numba</h3>
<div class="callout-content">
<p>Check if the Numba version of this conditional <code>sum range</code>
function outperforms its C counterpart.</p>
<p>Inspired by <a href="https://caswenson.com/2009_06_13_bypassing_the_python_gil_with_ctypes.html" class="external-link">a
blog by Christopher Swenson</a>.</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">C<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode c" tabindex="0"><code class="sourceCode c"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="dt">long</span> <span class="dt">long</span> conditional_sum_range<span class="op">(</span><span class="dt">long</span> <span class="dt">long</span> to<span class="op">)</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  <span class="dt">long</span> <span class="dt">long</span> i<span class="op">;</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>  <span class="dt">long</span> <span class="dt">long</span> s <span class="op">=</span> <span class="dv">0</span><span class="bu">LL</span><span class="op">;</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="bu">LL</span><span class="op">;</span> i <span class="op">&lt;</span> to<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i <span class="op">%</span> <span class="dv">3</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>      s <span class="op">+=</span> i<span class="op">;</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>  <span class="cf">return</span> s<span class="op">;</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="op">}</span></span></code></pre>
</div>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>Insert a line <code>if i%3==0:</code> in the code for
<code>sum_range_numba</code> and rename it to
<code>conditional_sum_range_numba</code>:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="at">@numba.jit</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="kw">def</span> conditional_sum_range_numba(a: <span class="bu">int</span>):</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>    x <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(a):</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>        <span class="cf">if</span> i<span class="op">%</span><span class="dv">3</span><span class="op">==</span><span class="dv">0</span>:</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>            x <span class="op">+=</span> i</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>    <span class="cf">return</span> x</span></code></pre>
</div>
<p>Let’s check how fast it runs:</p>
<pre><code>%timeit conditional_sum_range_numba(10**7)</code></pre>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>8.11 ms ± 15.6 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)</code></pre>
</div>
<p>Compare this with the run time of the C code for
conditional_sum_range. Compile and link in the usual way, assuming the
file name is still <code>test.c</code>:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="fu">gcc</span> <span class="at">-O3</span> <span class="at">-g</span> <span class="at">-fPIC</span> <span class="at">-c</span> <span class="at">-o</span> test.o test.c</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="fu">ld</span> <span class="at">-shared</span> <span class="at">-o</span> libtest.so test.o</span></code></pre>
</div>
<p>Again, we can time our compiled <code>conditional_sum_range</code> C
library, e.g. from the iPython interface:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="im">import</span> ctypes</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>testlib <span class="op">=</span> ctypes.cdll.LoadLibrary(<span class="st">"./libtest.so"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>conditional_sum_range <span class="op">=</span> testlib.conditional_sum_range</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>conditional_sum_range.argtypes <span class="op">=</span> [ctypes.c_longlong]</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>conditional_sum_range.restype <span class="op">=</span> ctypes.c_longlong</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="op">%</span>timeit conditional_sum_range(<span class="dv">10</span><span class="op">**</span><span class="dv">7</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>7.62 ms ± 49.7 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)</code></pre>
</div>
<p>The C code is somewhat faster than the Numba-decorated Python code
for this slightly more complicated example.</p>
</div>
</div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="passing-numpy-arrays-to-c-libraries">Passing Numpy arrays to C libraries<a class="anchor" aria-label="anchor" href="#passing-numpy-arrays-to-c-libraries"></a>
</h2>
<p>Now let us consider a more complex example. Instead of computing the
sum of numbers up to an upper limit, let us compute that for an array of
upper limits. This operation will return an array of sums. How difficult
is it to modify our C and Python code to get this done? You just need to
replace <code>&amp;sum_range</code> with
<code>py::vectorize(sum_range)</code>:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">C<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode c" tabindex="0"><code class="sourceCode c"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>PYBIND11_MODULE<span class="op">(</span>test_pybind<span class="op">,</span> m<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>    m<span class="op">.</span>doc<span class="op">()</span> <span class="op">=</span> <span class="st">"pybind11 example plugin"</span><span class="op">;</span> <span class="co">// optional module docstring</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>    m<span class="op">.</span>def<span class="op">(</span><span class="st">"sum_range"</span><span class="op">,</span> py<span class="op">::</span>vectorize<span class="op">(</span>sum_range<span class="op">),</span> <span class="st">"Adds upp consecutive integer numbers from 0 up to and including high-1"</span><span class="op">);</span></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a><span class="op">}</span></span></code></pre>
</div>
<p>Now let’s see what happens if we pass to <code>test_pybind.so</code>
an array instead of an integer.</p>
<p>The code:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="op">%</span><span class="im">import</span> test_pybind</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="op">%</span>sum_range<span class="op">=</span>test_pybind.sum_range</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="op">%</span>ys<span class="op">=</span><span class="bu">range</span>(<span class="dv">10</span>)</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a><span class="op">%</span>sum_range(ys)</span></code></pre>
</div>
<p>gives</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>array([ 0,  0,  1,  3,  6, 10, 15, 21, 28, 36])</code></pre>
</div>
<p>It does not crash! You can check that the array is correct upon
subtracting the previous sum from each sum (except the first):</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="op">%</span>out<span class="op">=</span>sum_range(ys)</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="op">%</span>out[<span class="dv">1</span>:]<span class="op">-</span>out[:<span class="op">-</span><span class="dv">1</span>]</span></code></pre>
</div>
<p>which gives</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>array([0, 1, 2, 3, 4, 5, 6, 7, 8])</code></pre>
</div>
<p>which are the elements of <code>ys</code> except the last, as
expected.</p>
</div>
</div>
<div class="section level1">
<h1 id="call-the-c-library-from-multiple-threads-simultaneously-">Call the C library from multiple threads simultaneously.<a class="anchor" aria-label="anchor" href="#call-the-c-library-from-multiple-threads-simultaneously-"></a>
</h1>
<p>We can show that a C library compiled using <code>pybind11</code> can
be run as multithreaded. Try the following from an iPython shell:</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="op">%</span>high<span class="op">=</span><span class="bu">int</span>(<span class="fl">1e9</span>)</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="op">%</span>timeit(sum_range(high))</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>274 ms ± 1.03 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
<p>Now try a straightforward parallelization of 20 calls of
<code>sum_range</code> over two threads, hence at 10 calls per thread.
This should take about <code>10 * 274 ms = 2.74 s</code> for a
parallelization free of overheads. Running:</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="im">import</span> threading <span class="im">as</span> T</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="kw">def</span> timer():</span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>    <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a>        t1 <span class="op">=</span> T.Thread(target<span class="op">=</span>sum_range, args<span class="op">=</span>(high,))</span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a>        t2 <span class="op">=</span> T.Thread(target<span class="op">=</span>sum_range, args<span class="op">=</span>(high,))</span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a>        t1.start()</span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a>        t2.start()</span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a>        t1.join()</span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a>        t2.join()</span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a>    end_time <span class="op">=</span> time.time()</span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Time elapsed = </span><span class="sc">{</span>end_time<span class="op">-</span>start_time<span class="sc">:.2f}</span><span class="ss">s"</span>)</span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a>timer()</span></code></pre>
</div>
<p>gives</p>
<pre><code>Time elapsed = 5.59s</code></pre>
<p>i.e., more than twice the time we expected. In fact, the
<code>sum_range</code> was run sequentially instead of parallelly. We
then need to add a single declaration to <code>test.c</code>:
<code>py::call_guard&lt;py::gil_scoped_release&gt;()</code>:</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">C<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode c" tabindex="0"><code class="sourceCode c"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>PYBIND11_MODULE<span class="op">(</span>test_pybind<span class="op">,</span> m<span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>    m<span class="op">.</span>doc<span class="op">()</span> <span class="op">=</span> <span class="st">"pybind11 example plugin"</span><span class="op">;</span> <span class="co">// optional module docstring</span></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a>    m<span class="op">.</span>def<span class="op">(</span><span class="st">"sum_range"</span><span class="op">,</span> py<span class="op">::</span>vectorize<span class="op">(</span>sum_range<span class="op">),</span> <span class="st">"Adds upp consecutive integer numbers from 0 up to and including high-1"</span><span class="op">);</span></span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a><span class="op">}</span></span></code></pre>
</div>
<p>as follows:</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">C<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode c" tabindex="0"><code class="sourceCode c"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>PYBIND11_MODULE<span class="op">(</span>test_pybind<span class="op">,</span> m<span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>    m<span class="op">.</span>doc<span class="op">()</span> <span class="op">=</span> <span class="st">"pybind11 example plugin"</span><span class="op">;</span> <span class="co">// optional module docstring</span></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>    m<span class="op">.</span>def<span class="op">(</span><span class="st">"sum_range"</span><span class="op">,</span> <span class="op">&amp;</span>sum_range<span class="op">,</span> <span class="st">"A function which adds upp numbers from 0 up to and including high-1"</span><span class="op">,</span> py<span class="op">::</span>call_guard<span class="op">&lt;</span>py<span class="op">::</span>gil_scoped_release<span class="op">&gt;());</span></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a><span class="op">}</span></span></code></pre>
</div>
<p>Now compile again:</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="ex">c++</span> <span class="at">-O3</span> <span class="at">-Wall</span> <span class="at">-shared</span> <span class="at">-std</span><span class="op">=</span>c++11 <span class="at">-fPIC</span> <span class="kw">`</span><span class="ex">python3</span> <span class="at">-m</span> pybind11 <span class="at">--includes</span><span class="kw">`</span> test.c <span class="at">-o</span> test_pybind.so</span></code></pre>
</div>
<p>Import again the rebuilt shared object (only possible after quitting
and relaunching the iPython interpreter), and time again.</p>
<p>This code:</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="im">import</span> test_pybind</span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a><span class="im">import</span> threading <span class="im">as</span> T</span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a>sum_range<span class="op">=</span>test_pybind.sum_range</span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a>high<span class="op">=</span><span class="bu">int</span>(<span class="fl">1e9</span>)</span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a><span class="kw">def</span> timer():</span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a>    <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb30-11"><a href="#cb30-11" tabindex="-1"></a>        t1 <span class="op">=</span> T.Thread(target<span class="op">=</span>sum_range, args<span class="op">=</span>(high,))</span>
<span id="cb30-12"><a href="#cb30-12" tabindex="-1"></a>        t2 <span class="op">=</span> T.Thread(target<span class="op">=</span>sum_range, args<span class="op">=</span>(high,))</span>
<span id="cb30-13"><a href="#cb30-13" tabindex="-1"></a>        t1.start()</span>
<span id="cb30-14"><a href="#cb30-14" tabindex="-1"></a>        t2.start()</span>
<span id="cb30-15"><a href="#cb30-15" tabindex="-1"></a>        t1.join()</span>
<span id="cb30-16"><a href="#cb30-16" tabindex="-1"></a>        t2.join()</span>
<span id="cb30-17"><a href="#cb30-17" tabindex="-1"></a>    end_time <span class="op">=</span> time.time()</span>
<span id="cb30-18"><a href="#cb30-18" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Time elapsed = </span><span class="sc">{</span>end_time<span class="op">-</span>start_time<span class="sc">:.2f}</span><span class="ss">s"</span>)</span>
<span id="cb30-19"><a href="#cb30-19" tabindex="-1"></a>timer()</span></code></pre>
</div>
<p>gives:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Time elapsed = 2.81s</code></pre>
</div>
<p>as you would expect for two <code>sum_range</code> modules running in
parallel.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Multiple options are available to call external C and C++ libraries,
and the best choice depends on the complexity of your problem.</li>
<li>Obviously, there is an extra compile-and-link step, but the
execution will be much faster than pure Python.</li>
<li>Also, the GIL will be circumvented in calling these libraries.</li>
<li>Numba might also offer you the speed-up you want with even less
effort.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://example.com/template-source/edit/main/README.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://example.com/template-source/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://example.com/template-source/" class="external-link">Source</a></p>
				<p><a href="https://example.com/template-source/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:j.hidding@esciencecenter.nl">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.11" class="external-link">sandpaper (0.16.11)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.9" class="external-link">pegboard (0.7.9)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.5" class="external-link">varnish (1.0.5)</a></p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://template-source.github.io/NA/instructor/aio.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://template-source.github.io/NA/instructor/aio.html",
  "identifier": "https://template-source.github.io/NA/instructor/aio.html",
  "dateCreated": "2025-03-31",
  "dateModified": "2025-04-01",
  "datePublished": "2025-04-01"
}

  </script><script>
		feather.replace();
	</script>
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

